name: Sync from Upstream

on:
  push:
    branches:
      - update-sync-github-action
  workflow_dispatch:

jobs:
  sync-and-create-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}
      - name: Set up Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
    
      - name: Add upstream remote and fetch
        run: |
          git remote add upstream https://github.com/uc-cdis/gen3-helm.git
          git fetch upstream master
          git fetch origin  # Ensure we have latest origin refs

      - name: Create and push sync branch
        run: |
          # Delete existing sync branch if it exists
          git push origin --delete sync-cdis-pcdc || true
          
          # Create sync branch from pcdc_dev
          git checkout -b sync-cdis-pcdc origin/pcdc_dev
          echo "Created sync-cdis-pcdc branch from pcdc_dev"

      - name: Attempt merge
        id: merge
        run: |
          # Store the current HEAD before merge
          BEFORE_MERGE=$(git rev-parse HEAD)
          echo "conflict_branch=false" >> $GITHUB_OUTPUT

          if git merge upstream/master --no-edit; then
            # Get the HEAD after merge
            AFTER_MERGE=$(git rev-parse HEAD)
            
            # Check if the merge actually created any changes
            if [ "$BEFORE_MERGE" = "$AFTER_MERGE" ]; then
              echo "merge_success=false" >> $GITHUB_OUTPUT
              echo "❌ No changes after merge - branches are already up to date"
              exit 0
            fi

            # Count actual changes from the merge
            CHANGES=$(git diff --name-only $BEFORE_MERGE $AFTER_MERGE | wc -l)

            
            # Verify we have actual changes before proceeding
            if [ "$CHANGES" -eq 0 ]; then
              echo "merge_success=false" >> $GITHUB_OUTPUT
              echo "❌ No file changes detected after merge"
              exit 0
            fi
            
            echo "merge_success=true" >> $GITHUB_OUTPUT
            echo "✅ Merge successful with changes"
          
          else
            echo "merge_success=false" >> $GITHUB_OUTPUT
            echo "conflict_branch=true" >> $GITHUB_OUTPUT
            echo "❌ Merge conflicts detected"
          fi

      - name: Push successful merge
        if: steps.merge.outputs.merge_success == 'true'
        run: |
          git push -u origin sync-cdis-pcdc
          echo "✅ Pushed sync-cdis-pcdc branch"

      - name: Wait for branch to be available
        if: steps.merge.outputs.merge_success == 'true'
        run: |
          echo "Waiting for branch to be available on GitHub..."
          sleep 10
          
          # Verify branches exist on GitHub
          echo "Checking if branches exist on GitHub..."
          gh api repos/chicagopcdc/gen3-helm/branches/pcdc_dev --jq .name
          gh api repos/chicagopcdc/gen3-helm/branches/sync-cdis-pcdc --jq .name
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Create Pull Request for successful merge
        if: steps.merge.outputs.merge_success == 'true'
        run: |
          echo "Creating PR with the following details:"
          echo "Base: pcdc_dev"
          echo "Head: sync-cdis-pcdc"
          echo "Files changed: ${{ steps.merge.outputs.files_changed }}"
          
          # Check if PR already exists
          if gh pr list --base pcdc_dev --head sync-cdis-pcdc --json number | jq -e '.[0]' > /dev/null; then
            echo "PR already exists, skipping creation"
            exit 0
          fi
          
          # Create the PR with explicit repository context
          gh pr create \
            --repo chicagopcdc/gen3-helm \
            --base pcdc_dev \
            --head sync-cdis-pcdc \
            --title "Sync: Upstream Master into pcdc_dev ($(date -u +%Y-%m-%d))" \
            --body "This PR automatically syncs changes from upstream/master into the pcdc_dev branch. Files changed: ${{ steps.merge.outputs.files_changed }}"
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Create conflict resolution branch
        if: steps.merge.outputs.merge_success == 'false' && steps.merge.outputs.conflict_branch == 'true'
        run: |
          # Create timestamped branch name
          TIMESTAMP=$(date -u +%Y%m%d-%H%M%S)
          CONFLICT_BRANCH="conflict-resolution-${TIMESTAMP}"
          
          # Create and push conflict resolution branch with unresolved conflicts
          git checkout -b "$CONFLICT_BRANCH"
          git push -u origin "$CONFLICT_BRANCH"
          
          echo "CONFLICT_BRANCH=${CONFLICT_BRANCH}" >> $GITHUB_ENV
          echo "Created conflict resolution branch: $CONFLICT_BRANCH"