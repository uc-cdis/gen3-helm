
apiVersion: karpenter.k8s.aws/v1beta1
kind: EC2NodeClass
metadata:
  name: jupyter
spec:
  amiFamily: {{ .Values.ami.family }}
  subnetSelectorTerms:
    - tags:
        karpenter.sh/discovery: "{{ .Values.cluster.name }}"
  securityGroupSelectorTerms:
    - tags:
        karpenter.sh/discovery: "{{ .Values.cluster.name }}-jupyter"

  role: "eks_{{ .Values.cluster.name }}_workers_role"

  amiSelectorTerms:
    - id: {{ .Values.ami.id }}

  # Optional, overrides autogenerated userdata with a merge semantic
  userData: {{ .Values.userdata | toYaml | nindent 4 }}

  # Optional, propagates tags to underlying EC2 resources
  tags:
    Environment: {{ .Values.cluster.name }}
    Name: eks-{{ .Values.cluster.name }}-jupyter-karpenter
    karpenter.sh/discovery: {{ .Values.cluster.name }}
    purpose: jupyter

  # Optional, configures IMDS for the instance
  metadataOptions:
    httpEndpoint: enabled
    httpProtocolIPv6: disabled
    httpPutResponseHopLimit: 2
    httpTokens: optional

  # Optional, configures storage devices for the instance
  blockDeviceMappings:
    - deviceName: {{ .Values.ebs.deviceName }}
      ebs:
        volumeSize: {{ .Values.ebs.volumeSize }}
        volumeType: {{ .Values.ebs.volumeType }}
        encrypted: {{ .Values.ebs.encrypted }}
        deleteOnTermination: {{ .Values.ebs.deleteOnTermination }}
---
apiVersion: karpenter.k8s.aws/v1beta1
kind: EC2NodeClass
metadata:
  name: default
spec:
  amiFamily: {{ .Values.ami.family }}
  subnetSelectorTerms:
    - tags:
        karpenter.sh/discovery: "{{ .Values.cluster.name }}"
  securityGroupSelectorTerms:
    - tags:
        karpenter.sh/discovery: "{{ .Values.cluster.name }}"

  role: "eks_{{ .Values.cluster.name }}_workers_role"

  amiSelectorTerms:
    - id: {{ .Values.ami.id }}

  # Optional, overrides autogenerated userdata with a merge semantic
  userData: {{ .Values.userdata | toYaml | nindent 4 }}

  # Optional, propagates tags to underlying EC2 resources
  tags:
    Environment: {{ .Values.cluster.name }}
    Name: eks-{{ .Values.cluster.name }}-karpenter
    karpenter.sh/discovery: {{ .Values.cluster.name }}
    purpose: default

  # Optional, configures IMDS for the instance
  metadataOptions:
    httpEndpoint: enabled
    httpProtocolIPv6: disabled
    httpPutResponseHopLimit: 2
    httpTokens: optional

  # Optional, configures storage devices for the instance
  blockDeviceMappings:
    - deviceName: {{ .Values.ebs.deviceName }}
      ebs:
        volumeSize: {{ .Values.ebs.volumeSize }}
        volumeType: {{ .Values.ebs.volumeType }}
        encrypted: {{ .Values.ebs.encrypted }}
        deleteOnTermination: {{ .Values.ebs.deleteOnTermination }}