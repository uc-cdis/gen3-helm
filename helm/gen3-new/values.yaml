# Default values for gen3.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# Global configuration
global:
  # -- (map) AWS configuration
  aws:
    # -- (string) AWS region for this deployment
    region: us-east-1
    # -- (bool) Set to true if deploying to AWS. Controls ingress annotations.
    enabled: false
    # -- (string) Credentials for AWS stuff.
    awsAccessKeyId:
    # -- (string) Credentials for AWS stuff.
    awsSecretAccessKey:
    externalSecrets:
      # -- (bool) Whether to use External Secrets for aws config.
      enabled: false
      # -- (String) Name of Secrets Manager secret.
      externalSecretAwsCreds:
      # -- (bool) Whether to create the database and Secrets Manager secrets via PushSecret.
      pushSecret: false
    # -- (map) Service account and AWS role for authentication to AWS Secrets Manager
    secretStoreServiceAccount:
      # -- (bool) Set true if deploying to AWS and want to use service account and IAM role instead of aws keys. Must provide role-arn.
      enabled: false
      # -- (string) Name of the service account to create
      name: secret-store-sa
      # -- (string) AWS Role ARN for Secret Store to use
      roleArn:
    # -- (map) Local secret setting if using a pre-exising secret.
    useLocalSecret:
      # -- (bool) Set to true if you would like to use a secret that is already running on your cluster.
      enabled: false
      # -- (string) Name of the local secret.
      localSecretName:
  # -- (map) Kubernetes configuration
  crossplane:
    # -- (bool) Set to true if deploying to AWS and want to use crossplane for AWS resources.
    enabled: false
    # -- (string) The name of the crossplane provider config.
    providerConfigName: provider-aws
    # -- (string) OIDC provider URL. This is used for authentication of roles/service accounts.
    oidcProviderUrl: oidc.eks.us-east-1.amazonaws.com/id/12345678901234567890
    # -- (string) The account ID of the AWS account.
    accountId: 123456789012
    s3:
      # -- (string) The kms key id for the s3 bucket.
      kmsKeyId:
      # -- (bool) Whether to use s3 bucket versioning.
      versioningEnabled: false

  # -- (bool) Deploys postgres/elasticsearch for dev
  dev: true
  postgres:
    # -- (bool) Whether the database create job should run.
    dbCreate: true
    # -- (string) Name of external secret of the postgres master credentials. Disabled if empty
    externalSecret: ""
    master:
      # -- global postgres master username
      username: postgres
      # -- global postgres master password
      password:
      # -- global postgres master host
      host:
      # -- global postgres master port
      port: "5432"
  # -- (string) Environment name.
  # This should be the same as vpcname if you're doing an AWS deployment.
  # Currently this is being used to share ALB's if you have multiple namespaces in same cluster.
  environment: default
  # -- (string) Kubernetes cluster name.
  clusterName: default
  # -- (string) Hostname for the deployment.
  hostname: localhost
  # -- (string) ARN of the reverse proxy certificate.
  revproxyArn: arn:aws:acm:us-east-1:123456:certificate
  # -- (string) URL of the data dictionary.
  dictionaryUrl: https://s3.amazonaws.com/dictionary-artifacts/datadictionary/develop/schema.json
  # -- (string) Portal application name.
  portalApp: gitops
  # -- (bool) Whether public datasets are enabled.
  publicDataSets: true
  # -- (string) Access level for tiers. acceptable values for `tier_access_level` are: `libre`, `regular` and `private`. If omitted, by default common will be treated as `private`
  tierAccessLevel: private
  # -- (int) Only relevant if tireAccessLevel is set to "regular". Summary charts below this limit will not appear for aggregated data.
  tierAccessLimit: "1000"
  logoutInactiveUsers: true
  workspaceTimeoutInMinutes: 480
  maintenanceMode: "off"
  dataUploadBucket:
  # fenceURL:
  # arboristURL:
  # indexdURL:
  # workspaceURL:
  # manifestServiceURL:
  # wtsURL:
  # privacyPolicyURL:
  # mapboxToken:
  # cookieDomain:
  # desNamespace:
  # -- (bool) Global flags to control and manage network policies for a Gen3 installation
  # NOTE: Network policies are currently a beta feature. Use with caution!
  netPolicy:
    # -- (bool) Whether network policies are enabled
    enabled: false

    # -- (array) A CIDR range representing a database subnet, that services with a database need access to
    dbSubnet: ""
  # -- (int) Number of dispatcher jobs.
  dispatcherJobNum: "10"
  # -- (bool) If the service will be deployed with a Pod Disruption Budget. Note- you need to have more than 2 replicas for the pdb to be deployed.
  pdb: false
  # -- (map) If you would like to add any extra values to the manifest-global configmap.
  manifestGlobalExtraValues: {}
  # -- (string) Which app will be served on /. Needs be set to portal for portal, or "gen3ff" for frontendframework.
  frontendRoot: "portal"
  # -- (bool) Will create a Kubernetes Secret for the slack webhook.
  createSlackWebhookSecret: false
  # -- (string) slack webhook for notifications
  slackWebhook: ""
  metricsEnabled: true
  # -- (map) External Secrets settings.
  externalSecrets:
    # -- (bool) Will use ExternalSecret resources to pull secrets from Secrets Manager instead of creating them locally. Be cautious as this will override secrets you have deployed.
    deploy: false
    # -- (bool) Will create the databases and store the creds in Kubernetes Secrets even if externalSecrets is deployed. Useful if you want to use ExternalSecrets for other secrets besides db secrets.
    createLocalK8sSecret: false
    clusterSecretStoreRef: ""
    # -- (bool) Will create a Kubernetes Secret for the slack webhook.
    createSlackWebhookSecret: false
    # -- (string) Name of the secret in Secrets Manager that contains the slack webhook.
    slackWebhookSecretName: ""
  topologySpread:
    # -- (bool) Whether to enable topology spread constraints for all subcharts that support it.
    enabled: false
    # -- (string) The topology key to use for spreading. Defaults to "topology.kubernetes.io/zone".
    topologyKey: "topology.kubernetes.io/zone"
    # -- (int) The maxSkew to use for topology spread constraints. Defaults to 1.
    maxSkew: 1

# -- (map) To configure postgresql subchart
# Disable persistence by default so we can spin up and down ephemeral environments
postgresql:
  image:
    repository: bitnamilegacy/postgresql
  primary:
    persistence:
      # -- (bool) Option to persist the dbs data.
      enabled: false

elasticsearch:
  clusterName: gen3-elasticsearch
  maxUnavailable: 0
  singleNode: true
  replicas: 1
  clusterHealthCheckParams: "wait_for_status=yellow&timeout=1s"
  esConfig:
    elasticsearch.yml: |
      # Here we can add elasticsearch config
  resources:
    requests:
      cpu: "500m"

mutatingWebhook:
  # -- (bool) Whether to deploy the mutating webhook service.
  enabled: false
  # -- (string) image
  image: quay.io/cdis/node-affinity-daemonset:feat_pods
# -- (map) Secret information for External Secrets and DB Secrets.

secrets:
  # -- (str) AWS access key ID. Overrides global key.
  awsAccessKeyId:
  # -- (str) AWS secret access key ID. Overrides global key.
  awsSecretAccessKey:

# Default configuration for auroraRdsCopyJob
auroraRdsCopyJob:
  enabled: false
  auroraMasterSecret: ""
  sourceNamespace: ""
  targetNamespace: ""
  writeToK8sSecret: false
  writeToAwsSecret: false
  services: []

arborist:
  # -- (bool) Whether to deploy the ambassador subchart.
  enabled: true
  dbService: true
  image:
    repository: quay.io/cdis/arborist
    tag: "master"
    pullPolicy: IfNotPresent
  livenessProbe:
    path: "/health"
  readinessProbe:
    path: "/health"
  command: ["sh"]
  args:
    - "-c"
    - |
      set -e
      # set env vars
      export PGSSLMODE="disable"
      
      # bring the database schema up to the latest version
      /go/src/github.com/uc-cdis/arborist/migrations/latest

      # run arborist
      /go/src/github.com/uc-cdis/arborist/bin/arborist
  env:
    - name: PGSSLMODE
      value: disable

  cronjobs:
    - name: arborist-rm-expired-access
      schedule: "*/5 * * * *"
      envFromApp: true
      dbSecretName: arborist-dbcreds
      affinityOverride: {}     # if empty, use default nodeAffinity
      automountServiceAccountToken: false
      command: ["sh"]
      args:
        - "-c"
        - |
          /go/src/github.com/uc-cdis/arborist/jobs/delete_expired_access
      dnsConfig:
        options:
          - name: use-vc
          - name: single-request-reopen