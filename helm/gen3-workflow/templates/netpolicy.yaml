{{ include "common.db_netpolicy" . }}

---

{{ include "common.ingress_netpolicy" . }}

---

{{ include "common.egress_netpolicy" . }}


{{ if .Values.global.netPolicy.enabled }}

{{ $jobsNamespace := .Values.funnel.Kubernetes.JobsNamespace | default .Release.Namespace }}

---
# funnel ingress from gen3-workflow and mongodb
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: funnel-ingress-from-gen3workflow-and-mongo-netpolicy
spec:
  podSelector:
    matchLabels:
      app: funnel
  ingress:
    - from:
      - podSelector:
          matchLabels:
            app: gen3-workflow
    - from:
      - podSelector:
          matchLabels:
            app.kubernetes.io/name: mongodb
      ports:
        - protocol: TCP
          port: 27017
  policyTypes:
    - Ingress
---
# Gen3-Workflow egress to funnel
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: funnel-egress-netpolicy
spec:
  podSelector:
    matchExpressions:
      - key: app
        operator: In
        #TODO: add funnel-mongodb label once funnel team adds it
        values:
          - gen3-workflow
          - funnel-worker
  egress:
    - to:
      - podSelector:
          matchLabels:
            app: funnel
  policyTypes:
    - Egress

---
# Need to his is temporary until funnel 
#adds a label gen3-mongodb for their mongodb service,
# then we can simplify this and combine multiple policies


# mongodb egress to funnel
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: mongodb-egress-to-funnel-and-funnel-worker
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: mongodb
  policyTypes:
    - Egress
  egress:
    - to:
      - namespaceSelector:
          matchLabels:
            kubernetes.io/metadata.name: {{ $jobsNamespace }}
        podSelector:
          matchLabels:
            app: funnel-worker
      ports:
        - protocol: TCP
          port: 27017
    - to:
      - podSelector:
          matchLabels:
            app: funnel
      ports:
        - protocol: TCP
          port: 27017
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: mongodb-ingress-from-funnel-and-funnel-worker
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: mongodb
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: {{ $jobsNamespace }}
      podSelector:
        matchLabels:
          app: funnel-worker
    ports:
      - protocol: TCP
        port: 27017
  - from:
    - podSelector:
        matchLabels:
            app: funnel
    ports:
    - protocol: TCP
      port: 27017
---
# Funnel egress to mongodb
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: mongodb-egress-netpolicy
spec:
  podSelector:
    matchLabels:
      app: funnel
  egress:
    - to:
      - podSelector:
          matchLabels:
            app.kubernetes.io/name: mongodb
      ports:
        - protocol: TCP
          port: 27017

  policyTypes:
    - Egress
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: funnel-to-funnel-worker-egress
  namespace: {{ .Release.Namespace }}
spec:
  podSelector:
    matchLabels:
      app: funnel
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: {{ $jobsNamespace }}
      podSelector:
        matchLabels:
          app: funnel-worker
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: funnel-to-kubeapi-egress
  namespace: {{ .Release.Namespace }}
spec:
  podSelector:
    matchLabels:
      app: funnel
  policyTypes:
  - Egress
  egress:
  # Allow access to the Kubernetes API server in kube-system
  - to: []
    ports:
      - protocol: TCP
        port: 443

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: funnel-from-funnel-worker-ingress
  namespace: {{ .Release.Namespace }}
spec:
  podSelector:
    matchLabels:
      app: funnel
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ $jobsNamespace }}
          podSelector:
            matchLabels:
              app: funnel-worker
  policyTypes:
    - Ingress

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: funnel-worker-to-dns-and-kubeapi-egress
  namespace: {{ $jobsNamespace }}
spec:
  podSelector:
    matchLabels:
      app: funnel-worker
  egress:
    - to: []
      ports:
        - protocol: TCP
          port: 443  # Kubernetes API
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
  policyTypes:
    - Egress
---

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: funnel-worker-to-mongo-and-gen3workflow-egress
  namespace: {{ $jobsNamespace }}
spec:
  podSelector:
    matchLabels:
      app: funnel-worker
  egress:
    - to:
      - namespaceSelector:
          matchLabels:
            kubernetes.io/metadata.name: {{ .Release.Namespace }}
        podSelector:
          matchLabels:
            app.kubernetes.io/name: mongodb
      ports:
        - protocol: TCP
          port: 27017
    - to:
      - namespaceSelector:
          matchLabels:
            kubernetes.io/metadata.name: {{ .Release.Namespace }}
        podSelector:
          matchLabels:
            app: gen3-workflow
  policyTypes:
    - Egress

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: gen3-workflow-from-funnel-worker-ingress
  namespace: {{ .Release.Namespace }}
spec:
  podSelector:
    matchLabels:
      app: gen3-workflow
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: {{ $jobsNamespace }}
      podSelector:
        matchLabels:
          app: funnel-worker
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: gen3-workflow-to-funnel-worker-egress
  namespace: {{ .Release.Namespace }}
spec:
  podSelector:
    matchLabels:
      app: gen3-workflow
  egress:
    - to:
      - namespaceSelector:
          matchLabels:
            kubernetes.io/metadata.name: {{ $jobsNamespace }}
        podSelector:
          matchLabels:
            app: funnel-worker
  policyTypes:
  - Egress

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: funnel-worker-from-funnel-gen3workflow-and-mongodb-ingress
  namespace: {{ $jobsNamespace }}
spec:
  podSelector:
    matchLabels:
      app: funnel-worker
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: {{ .Release.Namespace }}
      podSelector:
        matchExpressions:
          - key: app
            operator: In
            values:
              - funnel
              - gen3-workflow
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: {{ .Release.Namespace }}
      podSelector:
        matchLabels:
          app.kubernetes.io/name: mongodb
    ports:
      - protocol: TCP
        port: 27017
{{- end }}
