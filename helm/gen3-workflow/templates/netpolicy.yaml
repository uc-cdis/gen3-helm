{{ include "common.db_netpolicy" . }}

---

{{ include "common.ingress_netpolicy" . }}

---

{{ include "common.egress_netpolicy" . }}


{{ if .Values.global.netPolicy.enabled }}

{{ $jobsNamespace := .Values.funnel.Kubernetes.JobsNamespace | default .Release.Namespace }}

---
# Funnel needs both ingress and egress to/from gen3-workflow and funnel-mongodb
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: funnel-ingress-netpolicy
spec:
  podSelector:
    matchLabels:
      app: funnel
  ingress:
    - from:
      - podSelector:
          matchExpressions:
            - key: app
              operator: In
              values:
                - gen3-workflow
                - funnel-mongodb
  policyTypes:
    - Ingress
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: funnel-egress-netpolicy
spec:
  podSelector:
    matchExpressions:
      - key: app
        operator: In
        values:
          - gen3-workflow
          - funnel-mongodb
  egress:
    - to:
      - podSelector:
          matchLabels:
            app: funnel
  policyTypes:
    - Egress
---
# Gen3-workflow needs to allow ingress from funnel workers in $jobsNamespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: gen3-workflow-ingress-from-funnel-worker
  namespace: {{ .Release.Namespace }}
spec:
  podSelector:
    matchLabels:
      app: gen3-workflow
  policyTypes:
    - Ingress
  ingress:
    - from:
      - namespaceSelector:
          matchLabels:
            kubernetes.io/metadata.name: {{ $jobsNamespace }}
        podSelector:
          matchLabels:
            app: funnel-worker
---
# MongoDB needs to allow ingress from funnel in current namespace
# and funnel worker in $jobsNamespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: mongodb-ingress-netpolicy
spec:
  podSelector:
    matchLabels:
      app: funnel-mongodb
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
            app: funnel
    ports:
    - protocol: TCP
      port: 27017
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: {{ $jobsNamespace }}
      podSelector:
        matchLabels:
          app: funnel-worker
    ports:
      - protocol: TCP
        port: 27017
---
# Funnel egress to mongodb
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: mongodb-egress-netpolicy
spec:
  podSelector:
    matchLabels:
      app: funnel
  policyTypes:
  - Egress
  egress:
    - to:
      - podSelector:
          matchLabels:
            app: funnel-mongodb
      ports:
      - protocol: TCP
        port: 27017
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: funnel-worker-egress-policy
  namespace: {{ .Release.Namespace }}
spec:
  podSelector:
    matchExpressions:
      - key: app
        operator: In
        values:
          - funnel-mongodb
          - gen3-workflow
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: {{ $jobsNamespace }}
      podSelector:
        matchLabels:
          app: funnel-worker
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: funnel-worker-egress-to-mongo-and-gen3workflow
  namespace: {{ $jobsNamespace }}
spec:
  podSelector:
    matchLabels:
      app: funnel-worker
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: {{ .Release.Namespace }}
      podSelector:
        matchExpressions:
          - key: app
            operator: In
            values:
              - gen3-workflow
              - funnel-mongodb


---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: funnel-worker-ingress
  namespace: {{ $jobsNamespace }}
spec:
  podSelector:
    matchLabels:
      app: funnel-worker
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: {{ .Release.Namespace }}
      podSelector:
        matchExpressions:
          - key: app
            operator: In
            values:
              - gen3-workflow
              - funnel-mongodb
---
# Funnel needs to be able to access the Kube API to launch jobs in a different namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: funnel-to-kubeapi-egress
  namespace: {{ .Release.Namespace }}
spec:
  podSelector:
    matchLabels:
      app: funnel
  policyTypes:
  - Egress
  egress:
  # Allow access to the Kubernetes API server in kube-system
  - to: []
    ports:
      - protocol: TCP
        port: 443
---
# Funnel workers need to be able to access DNS 
# to interact with pods from different namespace
# and the Kube API to create excecutor pods
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: funnel-worker-to-dns-and-kubeapi-egress
  namespace: {{ $jobsNamespace }}
spec:
  podSelector:
    matchLabels:
      app: funnel-worker
  egress:
    - to: []
      ports:
        - protocol: TCP
          port: 443  # Kubernetes API
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
  policyTypes:
    - Egress
{{- end }}
