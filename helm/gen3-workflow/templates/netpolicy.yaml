{{ include "common.db_netpolicy" . }}

---

{{ include "common.ingress_netpolicy" . }}

---

{{ include "common.egress_netpolicy" . }}

{{- if .Values.global.netPolicy.enabled }}
--- 
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: funnel-ingress-netpolicy
spec:
  podSelector:
    matchLabels:
      app: funnel
  ingress:
    - from:
      - podSelector:
          matchExpressions:
            - key: app
              operator: In
              values: 
                - gen3-workflow
    - from:
      - podSelector:
          matchExpressions:
            - key: app.kubernetes.io/name
              operator: In
              values: 
                - mongodb
  policyTypes:
    - Ingress
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: funnel-egress-netpolicy
spec:
  podSelector:
    matchExpressions:
      - key: app
        operator: In
        values: 
          - gen3-workflow
  egress:
    - to:
      - podSelector:
          matchLabels:
            app: funnel
  policyTypes:
    - Egress

---
# mongodb egress to funnel, this is temporary until funnel 
# adds a label gen3-mongodb for their mongodb service,
# then we can combine this with funnel egress netpolicy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: mongodb-egress-to-funnel
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: mongodb
  egress:
    - to:
        - podSelector:
            matchLabels:
              app: funnel
  policyTypes:
    - Egress
{{- end }}