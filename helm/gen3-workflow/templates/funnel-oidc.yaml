{{- if and (.Values.oidc_job_enabled) (.Values.externalSecrets.createFunnelOidcClientSecret) }}
apiVersion: batch/v1
kind: Job
metadata:
  name: funnel-oidc-job
spec:
  template:
    metadata:
      labels:
        app: gen3job
    spec:
      restartPolicy: OnFailure
      serviceAccountName: funnel-secrets
      volumes:
        - name: config-volume
          secret:
            secretName: "fence-config"
        - name: shared-volume
          emptyDir: {}
      initContainers:
        - name: wait-for-fence
          image: curlimages/curl:latest
          imagePullPolicy: IfNotPresent
          command: ["/bin/sh","-c"]
          args: ["while [ $(curl -sw '%{http_code}' http://fence-service -o /dev/null) -ne 200 ]; do sleep 5; echo 'Waiting for fence...'; done"]
      containers:
        - name: fence-client
          # TODO: Make this configurable
          image: "quay.io/cdis/fence:master"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          # TODO: ADD RESOURCES
          # resources:
          command: ["/bin/bash"]
          args:
            - "-c"
            - |
              echo "Trying to generate Fence client for funnel..."

              secrets=$(fence-create client-create --client funnel-plugin-test --grant-types client_credentials | tail -1)
              if [[ ! $secrets =~ (\'(.*)\', \'(.*)\') ]]; then
                echo "Failed generating oidc client for workspace token service: $secrets"
                exit 1
              fi
              client_id="${BASH_REMATCH[2]}"
              client_secret="${BASH_REMATCH[3]}"
              echo client_id: $client_id
              echo client_secret: $client_secret
              echo -n $client_id > /shared/funnel_oidc_client_id
              echo -n $client_secret > /shared/funnel_oidc_client_secret
          env:
            - name: PGHOST
              valueFrom:
                secretKeyRef:
                  name: fence-dbcreds
                  key: host
                  optional: false  
            - name: PGUSER
              valueFrom:
                secretKeyRef:
                  name: fence-dbcreds
                  key: username
                  optional: false 
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: fence-dbcreds
                  key: password
                  optional: false
            - name: PGDB
              valueFrom:
                secretKeyRef:
                  name: fence-dbcreds
                  key: database
                  optional: false
            - name: DB
              value: postgresql://$(PGUSER):$(PGPASSWORD)@$(PGHOST):5432/$(PGDB)
            - name: PYTHONPATH
              value: /var/www/fence
            - name: FENCE_PUBLIC_CONFIG
              valueFrom:
                configMapKeyRef:
                  name: manifest-fence
                  key: fence-config-public.yaml
                  optional: true
          volumeMounts:
            - name: "shared-volume"
              mountPath: "/shared"
            - name: "config-volume"
              readOnly: true
              mountPath: "/var/www/fence/fence-config.yaml"
              subPath: fence-config.yaml
        - name: kubectl
          #TODO: Make this configurable?  
          image: bitnami/kubectl:latest
          volumeMounts:
            - name: "shared-volume"
              mountPath: "/shared"
          command: ["/bin/bash"]
          args: 
            - "-c"
            - |
              #!/bin/bash
              set -eo pipefail
              echo "waiting for /shared/funnel_oidc_client_id"
              while [ ! -e /shared/funnel_oidc_client_id ]
              do
                echo "..."
                sleep 5
              done
              echo "Updating k8s secret funnel-oidc-client"
              export CLIENT_ID=$(cat /shared/funnel_oidc_client_id)
              export CLIENT_SECRET=$(cat /shared/funnel_oidc_client_secret)
              kubectl get secret gen3workflow-g3auto -o jsonpath="{.data.funnel\.conf}" | base64 -d > /tmp/funnel.conf

              echo "Patching values..."
              yq eval '.Plugins.Params.OidcClientId = strenv(CLIENT_ID) | .Plugins.Params.OidcClientSecret = strenv(CLIENT_SECRET)' /tmp/funnel.conf > /tmp/funnel-patched.conf

              if [[ ! -s /tmp/funnel-patched.conf ]]; then
                echo "ERROR: Patched config is empty. Aborting."
                exit 1
              fi

              echo "Updating Kubernetes Secret..."
              echo "Patching funnel.conf in gen3workflow secret with new OIDC client credentials"
              PATCH=$(base64 -w 0 /tmp/funnel-patched.conf)
              kubectl patch secret gen3workflow-g3auto \
                --type merge \
                -p "{\"data\": {\"funnel.conf\": \"${PATCH}\"}}"

              echo "Patching funnel-oidc-client secret with new OIDC client credentials, currently used as a semaphore for funnel-server"
              kubectl patch secret/funnel-oidc-client --patch="{\"data\":{\"client_secret\":\"$(echo -n $CLIENT_SECRET | base64)\", \"client_id\":\"$(echo -n $CLIENT_ID | base64)\"}}"
{{- end }}
