{{- if or (not .Values.global.externalSecrets.deploy) (and .Values.global.externalSecrets.deploy .Values.externalSecrets.createK8sAuditSecret) }}
apiVersion: v1
kind: Secret
metadata:
  name: gen3workflow-g3auto
  labels:
    {{- include "gen3workflow.labels" . | nindent 4 }}
stringData: 
  gen3-workflow-config.yaml: |-
      ##########
      # SERVER #
      ##########

      HOSTNAME: {{ .Values.workflowConfig.hostname }}
      APP_DEBUG: {{ .Values.workflowConfig.debug }}
      HTTPX_DEBUG: {{ .Values.workflowConfig.httpxDebug }}
      DOCS_URL_PREFIX: {{ .Values.workflowConfig.docsUrlPrefix }}
      ARBORIST_URL: {{ .Values.workflowConfig.arboristUrl }}
      MOCK_AUTH: {{ .Values.workflowConfig.mockAuth }}

      ##########
      # AWS S3 #
      ##########

      USER_BUCKETS_REGION: {{ .Values.workflowConfig.userBucketsRegion }}
      S3_OBJECTS_EXPIRATION_DAYS: {{ .Values.workflowConfig.s3ObjectsExpirationDays }}
      S3_ENDPOINTS_AWS_ACCESS_KEY_ID: {{ .Values.workflowConfig.s3AccessKeyId }} #NOTE: This is not used when using IRSA
      S3_ENDPOINTS_AWS_SECRET_ACCESS_KEY: {{ .Values.workflowConfig.s3SecretAccessKey }} #NOTE: This is not used when using IRSA
      KMS_ENCRYPTION_ENABLED: {{ .Values.workflowConfig.kmsEncryptionEnabled }}

      #############
      # GA4GH TES #
      #############

      TES_SERVER_URL: {{ .Values.workflowConfig.tesServerUrl }}
      TASK_IMAGE_WHITELIST: {{ .Values.workflowConfig.taskImageWhitelist | toJson }}

      #############
      #  METRICS  #
      #############

      ENABLE_PROMETHEUS_METRICS: {{ .Values.workflowConfig.enablePrometheusMetrics }}
      PROMETHEUS_MULTIPROC_DIR: {{ .Values.workflowConfig.prometheusMultiprocDir }}

  funnel.conf: |-
    #This is the configuration file for the Funnel server coming from g3auto.
      Compute: kubernetes

      Kubernetes:
        Executor: kubernetes
        DisableReconciler: false
        DisableJobCleanup: false
        ReconcileRate: 600s
        Namespace: {{ .Release.Namespace }}
        JobsNamespace: {{ .Values.funnel.Kubernetes.JobsNamespace | default .Release.Namespace}}
        ServiceAccount: 

        # Worker Job
        WorkerTemplate: |
          apiVersion: batch/v1
          kind: Job
          metadata:
            name: {{`{{.TaskId}}`}}
            namespace: {{`{{.JobsNamespace}}`}}
            labels:
              app: funnel-worker
              task-id: {{`{{.TaskId}}`}}
              # Custom Labels support
              {{`{{- range $key, $value := .ExtraLabels }}`}}
              {{`{{ $key }}`}}: {{`{{ $value }}`}}
              {{`{{- end }}`}}
          spec:
            backoffLimit: 1
            completions: 1
            template:
              metadata:
                labels:
                  app: funnel-worker
                  task-id: {{`{{.TaskId}}`}}
              spec:
                serviceAccountName: funnel-sa-{{`{{.Namespace}}`}}
                restartPolicy: OnFailure
                containers:
                  - name: funnel-worker-{{`{{.TaskId}}`}}
                    image: {{`{{.Image}}`}}
                    imagePullPolicy: Always
                    args:
                      - "worker"
                      - "run"
                      - "--config"
                      - "/etc/config/funnel-worker.yaml"
                      - "--taskID"
                      - {{`{{.TaskId}}`}}
                    resources:
                      requests:
                        cpu: {{`{{if ne .Cpus 0 -}}{{.Cpus}}{{ else }}{{"100m"}}{{end}}`}}
                        memory: {{`{{if ne .RamGb 0.0 -}}{{printf "%.0fG" .RamGb}}{{else}}{{"16M"}}{{end}}`}}
                        ephemeral-storage: {{`{{if ne .DiskGb 0.0 -}}{{printf "%.0fG" .DiskGb}}{{else}}{{"100M"}}{{end}}`}}
                    volumeMounts:
                    - name: config-volume
                      mountPath: /etc/config
                    {{`{{- if .NeedsPVC }}`}} # Start: Conditional PVC Mount
                    - name: funnel-storage-{{`{{.TaskId}}`}}
                      mountPath: /opt/funnel/funnel-work-dir/{{`{{.TaskId}}`}}
                      subPath: {{`{{.TaskId}}`}}
                    {{`{{- end }}`}} # End: Conditional PVC Mount
                volumes:
                - name: config-volume
                  configMap:
                    name: funnel-worker-config-{{`{{.TaskId}}`}}
                {{`{{- if .NeedsPVC }}`}} # Start: Conditional PVC Volume Definition
                - name: funnel-storage-{{`{{.TaskId}}`}}
                  persistentVolumeClaim:
                    claimName: funnel-worker-pvc-{{`{{.TaskId}}`}}
                {{`{{- end }}`}} # End: Conditional PVC Volume Definition

        # Executor Job
        ExecutorTemplate: |
          apiVersion: batch/v1
          kind: Job
          metadata:
            name: {{`{{.TaskId}}`}}-{{`{{.JobId}}`}}
            namespace: {{`{{.JobsNamespace}}`}}
            labels:
              app: funnel-executor
              job-name: {{`{{.TaskId}}`}}-{{`{{.JobId}}`}}
              example-label: custom-executor
          spec:
            backoffLimit: 2
            completions: 1
            template:
              spec:
                # nodeSelector:
                #   role: workflow
                # tolerations:
                #   - key: "role"
                #     operator: "Equal"
                #     value: "workflow"
                #     effect: "NoSchedule"
                restartPolicy: OnFailure #Never
                serviceAccountName: funnel-sa-{{`{{.Namespace}}`}}
                containers:
                - name: funnel-worker-{{`{{.TaskId}}`}}
                  image: {{`{{.Image}}`}}
                  imagePullPolicy: IfNotPresent
                  command: ["/bin/sh", "-c"]
                  args: {{`{{.Command}}`}}
                  workingDir: {{`{{.Workdir}}`}}
                  resources:
                    requests:
                      cpu: {{`{{if ne .Cpus 0 -}}{{.Cpus}}{{ else }}{{"100m"}}{{end}}`}}
                      memory: {{`{{if ne .RamGb 0.0 -}}{{printf "%.0fG" .RamGb}}{{else}}{{"4G"}}{{end}}`}}
                      ephemeral-storage: {{`{{if ne .DiskGb 0.0 -}}{{printf "%.0fG" .DiskGb}}{{else}}{{"2G"}}{{end}}`}}
                  volumeMounts:
                  ### DO NOT CHANGE THIS
                  {{`{{- if .NeedsPVC }}`}} 
                    {{`{{range $idx, $item := .Volumes}}`}}
                    - name: funnel-storage-{{`{{$.TaskId}}`}}
                      mountPath: {{`{{$item.ContainerPath}}`}}
                      subPath: {{`{{$.TaskId}}`}}{{`{{$item.ContainerPath}}`}}
                    {{`{{end}}`}}
                  {{`{{- end }}`}}
                volumes:
                {{`{{- if .NeedsPVC }}`}}
                - name: funnel-storage-{{`{{.TaskId}}`}}
                  persistentVolumeClaim:
                    claimName: funnel-worker-pvc-{{`{{.TaskId}}`}}
                {{`{{- end }}`}}

        # PV template
        PVTemplate: |
          apiVersion: v1
          kind: PersistentVolume
          metadata:
            name: funnel-worker-pv-{{`{{.TaskId}}`}}
            labels:
              app: funnel
              taskId: {{`{{.TaskId}}`}}
          spec:
            storageClassName: ""
            capacity:
              storage: "10Mi"
            accessModes:
              - ReadWriteMany
            persistentVolumeReclaimPolicy: Retain
            mountOptions:
              - allow-delete
              - allow-overwrite
              - region={{`{{.Region}}`}}
              - file-mode=0755
            csi:
              driver: s3.csi.aws.com
              volumeHandle: s3-csi-{{`{{.TaskId}}`}}
              volumeAttributes:
                bucketName: {{`{{.Bucket}}`}}
            claimRef:
              namespace: {{`{{.Namespace}}`}}
              name: funnel-worker-pvc-{{`{{.TaskId}}`}}

        # PVC template
        PVCTemplate: |
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: funnel-worker-pvc-{{`{{.TaskId}}`}}
            namespace: {{`{{ .Namespace }}`}}
            labels:
              app: funnel
              taskId: {{`{{.TaskId}}`}}
          spec:
            storageClassName: ""
            accessModes:
              - ReadWriteMany
            resources:
              requests:
                storage: 10Mi
            volumeName: funnel-worker-pv-{{`{{.TaskId}}`}}
          


      Database: mongodb

      EventWriters:
        - mongodb
        - log

      Logger:
        level: debug
        outputFile: 

      Server:
        HostName: "funnel"
        HTTPPort: "8000"
        RPCPort: "9090"
        DisableHTTPCache: 

      RPCClient:
        ServerAddress: localhost:9090
        Timeout:
          duration: 60s
        MaxRetries: 10

      Scheduler:
        ScheduleRate: 1s
        ScheduleChunk: 10
        NodePingTimeout:
          duration: 60s
        NodeInitTimeout:
          duration: 300s

      Node:
        ID: 
        Timeout:
          disabled: true
        UpdateRate: 5s
        Resources:
          Cpus: 
          RamGb: 
          DiskGb: 

      Worker:
        WorkDir: ./funnel-work-dir
        PollingRate: 5s
        LogUpdateRate: 5s
        LogTailSize: 10000
        LeaveWorkDir: false
        MaxParallelTransfers: 10

      BoltDB:
        Path: ./funnel-work-dir/funnel.db

      AmazonS3:
        Disabled: true
        AWSConfig:
          MaxRetries: 10
          Key: 
          Secret: 
        SSE:
          CustomerKeyFile: 
          KMSKey: 

      DynamoDB:
        TableBasename: funnel
        AWSConfig:
          Region: 
          Key: 
          Secret: 

      Elastic:
        IndexPrefix: funnel
        URL: 

      Datastore:
        Project: 
        CredentialsFile: 

      MongoDB:
        Addrs:
          - {{ .Release.Name }}-mongodb.{{ .Release.Namespace }}.svc.cluster.local
        Database: funnel
        Timeout:
          duration: 300s
        Username: example
        Password: example

      Kafka:
        Servers:
        - ""
        Topic: funnel

      GenericS3:
        - Disabled: true
          Endpoint: 
          Key: 
          Secret: 
          Bucket: 
          Region: 
          KmsKeyID: 
      Plugins:
        Path: plugin-binaries/auth-plugin
        Params:
          OidcClientId: <redacted>
          OidcClientSecret: <redacted>
          S3Url: gen3-workflow-service.{{ .Release.Namespace }}.svc.cluster.local
          OidcTokenUrl: https://{{ .Values.workflowConfig.hostname }}/user 
{{- end }}

---
apiVersion: v1
kind: Secret
metadata:
  name: funnel-oidc-client