{{- if or (not .Values.global.externalSecrets.deploy) (and .Values.global.externalSecrets.deploy .Values.externalSecrets.createK8sAuditSecret) }}
apiVersion: v1
kind: Secret
metadata:
  name: audit-g3auto
  labels:
    {{- include "audit.labels" . | nindent 4 }}
stringData: 
  audit-service-config.yaml: |-
      ####################
      # SERVER           #
      ####################
      # whether to enable debug logs
      DEBUG: {{ .Values.server.debug }}

      # If `PULL_FROM_QUEUE` is true, `QUEUE_CONFIG` is required. Otherwise,
      # logs can only be created by hitting the API's log creation endpoint.
      PULL_FROM_QUEUE: {{ .Values.server.pull_from_queue }}

      # `QUEUE_CONFIG.type` is one of: [api, aws_sqs].
      # - if type == aws_sqs: logs are pulled from an SQS and `aws_sqs_config`
      # fields `sqs_url` and `region` are required. Field `aws_cred` is optional and
      # it should be a key in section `AWS_CREDENTIALS`.
      QUEUE_CONFIG:
        type: {{ .Values.server.type }}
        aws_sqs_config:
            sqs_url: {{ .Values.server.sqs.url }}
            region: {{ .Values.server.sqs.region }}
            {{- if .Values.server.sqs.aws_creds }}
            aws_cred: {{ .Values.server.sqs.aws_creds }}
            {{- end }}

      # defaults to "http://arborist-service/"
      ARBORIST_URL: {{ .Values.server.arboristUrl }}
      # how often to check the queue for new audit logs after seeing an empty queue
      # defaults to 5 minutes
      PULL_FREQUENCY_SECONDS: {{ default 300 .Values.server.pull_frequency_seconds }}

      # NOTE: Remove the {} and supply creds if needed. Example in comments below
      AWS_CREDENTIALS:
{{- with .Values.server.AWS_CREDENTIALS }}
{{- range $name, $creds := . }}
        {{ $name | upper }}:
          aws_access_key_id: {{ default "" $creds.aws_access_key_id | quote }}
          aws_secret_access_key: {{ default "" $creds.aws_secret_access_key | quote }}
{{- end }}
{{- else }}
        {}
{{- end }}
      ####################
      # API              #
      ####################

      # if left empty, queries are not time-boxed
      QUERY_TIMEBOX_MAX_DAYS: {{ .Values.api.QUERY_TIMEBOX_MAX_DAYS }}

      QUERY_PAGE_SIZE: {{ .Values.api.QUERY_PAGE_SIZE }}

      # whether to return usernames in query responses,
      # and to allow querying by username
      QUERY_USERNAMES: {{ .Values.api.QUERY_USERNAMES }}
{{- end }}