# alloy

![Version: 0.1.2](https://img.shields.io/badge/Version-0.1.2-informational?style=flat-square) ![Type: application](https://img.shields.io/badge/Type-application-informational?style=flat-square) ![AppVersion: master](https://img.shields.io/badge/AppVersion-master-informational?style=flat-square)

A Helm chart for deploying Grafana Alloy

## Requirements

| Repository | Name | Version |
|------------|------|---------|
| https://grafana.github.io/helm-charts | alloy | 0.9.1 |

## Values

| Key | Type | Default | Description |
|-----|------|---------|-------------|
| alloy.alloy.clustering.enabled | bool | `true` |  |
| alloy.alloy.configMap.key | string | `"config"` |  |
| alloy.alloy.configMap.name | string | `"alloy-gen3"` |  |
| alloy.alloy.extraPorts | list | `[{"name":"otel-grpc","port":4317,"protocol":"TCP","targetPort":4317},{"name":"otel-http","port":4318,"protocol":"TCP","targetPort":4318}]` | Extra ports to expose on the Alloy container. |
| alloy.alloy.resources.requests.cpu | string | `"1000m"` |  |
| alloy.alloy.resources.requests.memory | string | `"1Gi"` |  |
| alloy.alloy.stabilityLevel | string | `"public-preview"` |  |
| alloy.alloy.uiPathPrefix | string | `"/alloy"` |  |
| alloy.alloyConfigmapData | string | `"logging {\n  level    = \"info\"\n  format   = \"json\"\n  write_to = [loki.write.endpoint.receiver]\n}\n\n/////////////////////// OTLP START ///////////////////////\n\notelcol.receiver.otlp \"default\" {\n  grpc {}\n  http {}\n\n  output {\n    metrics = [otelcol.processor.batch.default.input]\n    traces = [otelcol.processor.batch.default.input]\n  }\n}\n\notelcol.processor.batch \"default\" {\n  output {\n    metrics = [otelcol.exporter.prometheus.default.input]\n    traces  = [otelcol.exporter.otlp.tempo.input]\n  }\n}\n\notelcol.exporter.prometheus \"default\" {\n  forward_to = [prometheus.remote_write.default.receiver]\n}\n\notelcol.exporter.otlp \"tempo\" {\n  client {\n    endpoint = \"http://monitoring-tempo-distributor.monitoring:4317\"\n    // Configure TLS settings for communicating with the endpoint.\n    tls {\n        // The connection is insecure.\n        insecure = true\n        // Do not verify TLS certificates when connecting.\n        insecure_skip_verify = true\n    }\n  }\n}\n\n\n/////////////////////// OTLP END ///////////////////////\n\n// discover all pods, to be used later in this config\ndiscovery.kubernetes \"pods\" {\n  role = \"pod\"\n}\n\n// discover all services, to be used later in this config\ndiscovery.kubernetes \"services\" {\n  role = \"service\"\n}\n\n// discover all nodes, to be used later in this config\ndiscovery.kubernetes \"nodes\" {\n  role = \"node\"\n}\n\n// Generic scrape of any pod with Annotation \"prometheus.io/scrape: true\"\ndiscovery.relabel \"annotation_autodiscovery_pods\" {\n  targets = discovery.kubernetes.pods.targets\n  rule {\n    source_labels = [\"__meta_kubernetes_pod_annotation_prometheus_io_scrape\"]\n    regex = \"true\"\n    action = \"keep\"\n  }\n  rule {\n    source_labels = [\"__meta_kubernetes_pod_annotation_prometheus_io_job\"]\n    action = \"replace\"\n    target_label = \"job\"\n  }\n  rule {\n    source_labels = [\"__meta_kubernetes_pod_annotation_prometheus_io_instance\"]\n    action = \"replace\"\n    target_label = \"instance\"\n  }\n  rule {\n    source_labels = [\"__meta_kubernetes_pod_annotation_prometheus_io_path\"]\n    action = \"replace\"\n    target_label = \"__metrics_path__\"\n  }\n\n  // Choose the pod port\n  // The discovery generates a target for each declared container port of the pod.\n  // If the metricsPortName annotation has value, keep only the target where the port name matches the one of the annotation.\n  rule {\n    source_labels = [\"__meta_kubernetes_pod_container_port_name\"]\n    target_label = \"__tmp_port\"\n  }\n  rule {\n    source_labels = [\"__meta_kubernetes_pod_annotation_prometheus_io_portName\"]\n    regex = \"(.+)\"\n    target_label = \"__tmp_port\"\n  }\n  rule {\n    source_labels = [\"__meta_kubernetes_pod_container_port_name\"]\n    action = \"keepequal\"\n    target_label = \"__tmp_port\"\n  }\n\n  // If the metrics port number annotation has a value, override the target address to use it, regardless whether it is\n  // one of the declared ports on that Pod.\n  rule {\n    source_labels = [\"__meta_kubernetes_pod_annotation_prometheus_io_port\", \"__meta_kubernetes_pod_ip\"]\n    regex = \"(\\\\d+);(([A-Fa-f0-9]{1,4}::?){1,7}[A-Fa-f0-9]{1,4})\"\n    replacement = \"[$2]:$1\" // IPv6\n    target_label = \"__address__\"\n  }\n  rule {\n    source_labels = [\"__meta_kubernetes_pod_annotation_prometheus_io_port\", \"__meta_kubernetes_pod_ip\"]\n    regex = \"(\\\\d+);((([0-9]+?)(\\\\.|$)){4})\" // IPv4, takes priority over IPv6 when both exists\n    replacement = \"$2:$1\"\n    target_label = \"__address__\"\n  }\n\n  rule {\n    source_labels = [\"__meta_kubernetes_pod_annotation_prometheus_io_scheme\"]\n    action = \"replace\"\n    target_label = \"__scheme__\"\n  }\n\n\n  // add labels\n  rule {\n    source_labels = [\"__meta_kubernetes_pod_name\"]\n    target_label = \"pod\"\n  }\n  rule {\n    source_labels = [\"__meta_kubernetes_pod_container_name\"]\n    target_label = \"container\"\n  }\n  rule {\n    source_labels = [\"__meta_kubernetes_pod_controller_name\"]\n    target_label = \"controller\"\n  }\n\n  rule {\n    source_labels = [\"__meta_kubernetes_namespace\"]\n    target_label = \"namespace\"\n  }\n\n\n  rule {\n    source_labels = [\"__meta_kubernetes_pod_label_app\"]\n    target_label = \"app\"\n  }\n\n  // map all labels\n  rule {\n    action = \"labelmap\"\n    regex  = \"__meta_kubernetes_pod_label_(.+)\"\n  }\n}\n\n// Generic scrape of any service with\n// Annotation Autodiscovery\ndiscovery.relabel \"annotation_autodiscovery_services\" {\n  targets = discovery.kubernetes.services.targets\n  rule {\n    source_labels = [\"__meta_kubernetes_service_annotation_prometheus_io_scrape\"]\n    regex = \"true\"\n    action = \"keep\"\n  }\n  rule {\n    source_labels = [\"__meta_kubernetes_service_annotation_prometheus_io_job\"]\n    action = \"replace\"\n    target_label = \"job\"\n  }\n  rule {\n    source_labels = [\"__meta_kubernetes_service_annotation_prometheus_io_instance\"]\n    action = \"replace\"\n    target_label = \"instance\"\n  }\n  rule {\n    source_labels = [\"__meta_kubernetes_service_annotation_prometheus_io_path\"]\n    action = \"replace\"\n    target_label = \"__metrics_path__\"\n  }\n\n  // Choose the service port\n  rule {\n    source_labels = [\"__meta_kubernetes_service_port_name\"]\n    target_label = \"__tmp_port\"\n  }\n  rule {\n    source_labels = [\"__meta_kubernetes_service_annotation_prometheus_io_portName\"]\n    regex = \"(.+)\"\n    target_label = \"__tmp_port\"\n  }\n  rule {\n    source_labels = [\"__meta_kubernetes_service_port_name\"]\n    action = \"keepequal\"\n    target_label = \"__tmp_port\"\n  }\n\n  rule {\n    source_labels = [\"__meta_kubernetes_service_port_number\"]\n    target_label = \"__tmp_port\"\n  }\n  rule {\n    source_labels = [\"__meta_kubernetes_service_annotation_prometheus_io_port\"]\n    regex = \"(.+)\"\n    target_label = \"__tmp_port\"\n  }\n  rule {\n    source_labels = [\"__meta_kubernetes_service_port_number\"]\n    action = \"keepequal\"\n    target_label = \"__tmp_port\"\n  }\n\n  rule {\n    source_labels = [\"__meta_kubernetes_service_annotation_prometheus_io_scheme\"]\n    action = \"replace\"\n    target_label = \"__scheme__\"\n  }\n}\n\nprometheus.scrape \"metrics\" {\n  job_name   = \"integrations/autodiscovery_metrics\"\n  targets  = concat(discovery.relabel.annotation_autodiscovery_pods.output, discovery.relabel.annotation_autodiscovery_services.output)\n  honor_labels = true\n  clustering {\n    enabled = true\n  }\n  forward_to = [prometheus.relabel.metrics_service.receiver]\n}\n\n\n// Node Exporter\n// TODO: replace with https://grafana.com/docs/alloy/latest/reference/components/prometheus.exporter.unix/\ndiscovery.relabel \"node_exporter\" {\n  targets = discovery.kubernetes.pods.targets\n  rule {\n    source_labels = [\"__meta_kubernetes_pod_label_app_kubernetes_io_instance\"]\n    regex = \"monitoring-extras\"\n    action = \"keep\"\n  }\n  rule {\n    source_labels = [\"__meta_kubernetes_pod_label_app_kubernetes_io_name\"]\n    regex = \"node-exporter\"\n    action = \"keep\"\n  }\n  rule {\n    source_labels = [\"__meta_kubernetes_pod_node_name\"]\n    action = \"replace\"\n    target_label = \"instance\"\n  }\n}\n\nprometheus.scrape \"node_exporter\" {\n  job_name   = \"integrations/node_exporter\"\n  targets  = discovery.relabel.node_exporter.output\n  scrape_interval = \"60s\"\n  clustering {\n    enabled = true\n  }\n  forward_to = [prometheus.relabel.node_exporter.receiver]\n}\n\nprometheus.relabel \"node_exporter\" {\n  rule {\n    source_labels = [\"__name__\"]\n    regex = \"up|node_cpu.*|node_network.*|node_exporter_build_info|node_filesystem.*|node_memory.*|process_cpu_seconds_total|process_resident_memory_bytes\"\n    action = \"keep\"\n  }\n  forward_to = [prometheus.relabel.metrics_service.receiver]\n}\n\n// Logs from all pods\ndiscovery.relabel \"all_pods\" {\n  targets = discovery.kubernetes.pods.targets\n  rule {\n    source_labels = [\"__meta_kubernetes_namespace\"]\n    target_label = \"namespace\"\n  }\n  rule {\n    source_labels = [\"__meta_kubernetes_pod_name\"]\n    target_label = \"pod\"\n  }\n  rule {\n    source_labels = [\"__meta_kubernetes_pod_container_name\"]\n    target_label = \"container\"\n  }\n  rule {\n    source_labels = [\"__meta_kubernetes_pod_controller_name\"]\n    target_label = \"controller\"\n  }\n\n  rule {\n    source_labels = [\"__meta_kubernetes_pod_label_app\"]\n    target_label = \"app\"\n  }\n\n  // map all labels\n  rule {\n    action = \"labelmap\"\n    regex  = \"__meta_kubernetes_pod_label_(.+)\"\n  }\n\n}\n\nloki.source.kubernetes \"pods\" {\n  targets = discovery.relabel.all_pods.output\n  forward_to = [loki.write.endpoint.receiver]\n}\n\n// kube-state-metrics\ndiscovery.relabel \"relabel_kube_state_metrics\" {\n  targets = discovery.kubernetes.services.targets\n  rule {\n    source_labels = [\"__meta_kubernetes_namespace\"]\n    regex = \"monitoring\"\n    action = \"keep\"\n  }\n  rule {\n    source_labels = [\"__meta_kubernetes_service_name\"]\n    regex = \"monitoring-extras-kube-state-metrics\"\n    action = \"keep\"\n  }\n}\n\nprometheus.scrape \"kube_state_metrics\" {\n  targets = discovery.relabel.relabel_kube_state_metrics.output\n  job_name = \"kube-state-metrics\"\n  metrics_path = \"/metrics\"\n  forward_to = [prometheus.remote_write.default.receiver]\n}\n\n// Kubelet\ndiscovery.relabel \"kubelet\" {\n  targets = discovery.kubernetes.nodes.targets\n  rule {\n    target_label = \"__address__\"\n    replacement  = \"kubernetes.default.svc.cluster.local:443\"\n  }\n  rule {\n    source_labels = [\"__meta_kubernetes_node_name\"]\n    regex         = \"(.+)\"\n    replacement   = \"/api/v1/nodes/${1}/proxy/metrics\"\n    target_label  = \"__metrics_path__\"\n  }\n}\n\nprometheus.scrape \"kubelet\" {\n  job_name   = \"integrations/kubernetes/kubelet\"\n  targets  = discovery.relabel.kubelet.output\n  scheme   = \"https\"\n  scrape_interval = \"60s\"\n  bearer_token_file = \"/var/run/secrets/kubernetes.io/serviceaccount/token\"\n  tls_config {\n    insecure_skip_verify = true\n  }\n  clustering {\n    enabled = true\n  }\n  forward_to = [prometheus.relabel.kubelet.receiver]\n}\n\nprometheus.relabel \"kubelet\" {\n  rule {\n    source_labels = [\"__name__\"]\n    regex = \"up|container_cpu_usage_seconds_total|kubelet_certificate_manager_client_expiration_renew_errors|kubelet_certificate_manager_client_ttl_seconds|kubelet_certificate_manager_server_ttl_seconds|kubelet_cgroup_manager_duration_seconds_bucket|kubelet_cgroup_manager_duration_seconds_count|kubelet_node_config_error|kubelet_node_name|kubelet_pleg_relist_duration_seconds_bucket|kubelet_pleg_relist_duration_seconds_count|kubelet_pleg_relist_interval_seconds_bucket|kubelet_pod_start_duration_seconds_bucket|kubelet_pod_start_duration_seconds_count|kubelet_pod_worker_duration_seconds_bucket|kubelet_pod_worker_duration_seconds_count|kubelet_running_container_count|kubelet_running_containers|kubelet_running_pod_count|kubelet_running_pods|kubelet_runtime_operations_errors_total|kubelet_runtime_operations_total|kubelet_server_expiration_renew_errors|kubelet_volume_stats_available_bytes|kubelet_volume_stats_capacity_bytes|kubelet_volume_stats_inodes|kubelet_volume_stats_inodes_used|kubernetes_build_info|namespace_workload_pod|rest_client_requests_total|storage_operation_duration_seconds_count|storage_operation_errors_total|volume_manager_total_volumes\"\n    action = \"keep\"\n  }\n  forward_to = [prometheus.relabel.metrics_service.receiver]\n}\n\n// Cluster Events\nloki.source.kubernetes_events \"cluster_events\" {\n  job_name   = \"integrations/kubernetes/eventhandler\"\n  log_format = \"logfmt\"\n  forward_to = [loki.write.endpoint.receiver]\n}\n\nprometheus.relabel \"metrics_service\" {\n  forward_to = [prometheus.remote_write.default.receiver]\n}\n\n\n// Write Endpoints\n// prometheus write endpoint\nprometheus.remote_write \"default\" {\n  external_labels = {\n    cluster = \"{{ .Values.cluster }}\",\n    project = \"{{ .Values.project }}\",\n  }\n  endpoint {\n    url = \"https://mimir.example.com/api/v1/push\"\n\n    headers = {\n      \"X-Scope-OrgID\" = \"anonymous\",\n    }\n\n  }\n}\n\n// loki write endpoint\nloki.write \"endpoint\" {\n  external_labels =  {\n    cluster = \"{{ .Values.cluster }}\",\n    project = \"{{ .Values.project }}\",\n  }\n  endpoint {\n    url = \"https://loki.example.com/loki/api/v1/push\"\n  }\n}\n"` |  |
| alloy.controller.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms[0].matchExpressions[0].key | string | `"topology.kubernetes.io/zone"` |  |
| alloy.controller.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms[0].matchExpressions[0].operator | string | `"In"` |  |
| alloy.controller.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms[0].matchExpressions[0].values[0] | string | `"us-east-1a"` |  |
| alloy.controller.type | string | `"deployment"` |  |
