apiVersion: v1
kind: Secret
metadata:
  name: portal-config
  annotations:
    argocd.argoproj.io/sync-options: Replace=true
data:
  {{- if .Values.gitops.createdby }}
  gitops-createdby.png: |
    {{- .Values.gitops.createdby | nindent 4 }}
  {{- else }}
  gitops-createdby.png: |
    {{- (.Files.Get "defaults/gitops-createdby.png" | b64enc) | nindent 4 }}
  {{- end }}
  {{- if .Values.gitops.css }}
  gitops.css: |
    {{- .Values.gitops.css | b64enc | nindent 4 }}
  {{- else }}
  gitops.css: |
    {{- (.Files.Get "defaults/gitops.css" | b64enc) | nindent 4 }}
  {{- end }}
  {{- if .Values.gitops.favicon }}
  gitops-favicon.ico: |
    {{- .Values.gitops.favicon | nindent 4 }}
  {{- else }}
  gitops-favicon.ico: |
    {{- (.Files.Get "defaults/gitops-favicon.ico" | b64enc) | nindent 4 }}
  {{- end }}
  {{- if .Values.gitops.json }}
  gitops.json: |
    {{- .Values.gitops.json | b64enc | nindent 4 }}
  {{- else }}
  gitops.json: |
    {{- (.Files.Get "defaults/gitops.json" | b64enc) | nindent 4 }}
  {{- end }}
  {{- if .Values.gitops.logo }}
  gitops-logo.png: |
    {{- .Values.gitops.logo  | nindent 4 }}
  {{- else }}
  gitops-logo.png: |
    {{- (.Files.Get "defaults/gitops-logo.png" | b64enc) | nindent 4 }}
  {{- end }}
---
apiVersion: v1
kind: Secret
metadata:
  name: portal-sponsor-config
  annotations:
    argocd.argoproj.io/sync-options: Replace=true
data:
{{- range $key, $value := .Values.gitops.sponsors }}
  {{ $key }}: {{ $value  }}
{{- end }}
---
{{- if .Values.portalBuild.enabled -}}
apiVersion: v1
kind: Secret
metadata:
  name: compute-signature
type: Opaque
stringData:
  compute_signature.sh: |
    #!/usr/bin/env bash
    set -euo pipefail
    : "${APP:=dev}"
    : "${GEN3_BUNDLE:=commons}"
    : "${BASENAME:=}"
    : "${NODE_ENV:=production}"
    cd /data-portal
    hash_line() {
      local f="$1"
      if [[ -f "$f" ]]; then
        if command -v sha256sum >/dev/null 2>&1; then
          sha256sum "$f"
        elif command -v shasum >/dev/null 2>&1; then
          shasum -a 256 "$f"
        else
          printf 'mtime+size:%s %s\n' "$(stat -c '%Y+%s' "$f" 2>/dev/null || stat -f '%m+%z' "$f")" "$f"
        fi
      else
        printf 'missing:%s\n' "$f"
      fi
    }
    {
      printf 'APP=%s\n' "${APP}"
      printf 'BASENAME=%s\n' "${BASENAME}"
      printf 'GEN3_BUNDLE=%s\n' "${GEN3_BUNDLE}"
      printf 'NODE_ENV=%s\n' "production"
      hash_line "webpack.config.js"
      hash_line "package-lock.json"
      hash_line "yarn.lock"
      hash_line "data/config/default.json"
      hash_line "data/config/${APP}.json"
      hash_line "src/index.jsx"
      hash_line "src/workspaceIndex.jsx"
      hash_line "src/covid19Index.jsx"
      hash_line "src/nctIndex.jsx"
      hash_line "src/ecosystemIndex.jsx"
      hash_line "src/css/themeoverrides.css"
    } | { sha256sum 2>/dev/null || shasum -a 256; } | awk '{print $1}'
---
apiVersion: v1
kind: Secret
metadata:
  name: check-and-trigger
type: Opaque
stringData:
  check_and_trigger_build.sh: |
    #!/usr/bin/env bash
    set -euo pipefail

    : "${NAMESPACE:=default}"
    : "${SIG_CONFIGMAP_NAME:=webpack-build-sig}"
    : "${LOCK_CONFIGMAP_NAME:=webpack-build-lock}"
    : "${JOB_NAME_PREFIX:=webpack-build}"
    : "${BUILDER_IMAGE:=quay.io/cdis/data-portal:2024.12}"
    : "${PVC_NAME:=webpack-pvc}"
    : "${LOCK_TTL_SECONDS:=1800}"

    : "${APP:=dev}"
    : "${GEN3_BUNDLE:=commons}"
    : "${BASENAME:=}"
    : "${NODE_ENV:=production}"

    # Prefer precomputed sig (from sig-compute init)
    NEW_SIG=""
    for f in /etc/portal-build/sig /sig/new_sig; do
      if [ -s "$f" ]; then
        NEW_SIG="$(tr -d '\n' < "$f")"
        echo "[INFO] using precomputed signature from $f: $NEW_SIG"
        break
      fi
    done
    if [ -z "$NEW_SIG" ]; then
      if [ -x /scripts/compute_signature.sh ]; then
        cd /data-portal
        chmod +x /scripts/compute_signature.sh
        NEW_SIG="$(
          APP="$APP" GEN3_BUNDLE="$GEN3_BUNDLE" BASENAME="$BASENAME" NODE_ENV="$NODE_ENV" \
          /scripts/compute_signature.sh
        )"
        echo "[INFO] computed signature: ${NEW_SIG}"
      else
        echo "[ERROR] no signature available"
        exit 1
      fi
    fi

    # If current sig equals desired sig, skip
    CURRENT_SIG="$(kubectl -n "$NAMESPACE" get configmap "$SIG_CONFIGMAP_NAME" -o jsonpath='{.data.sig}' 2>/dev/null || true)"
    if [[ -n "${CURRENT_SIG}" && "${CURRENT_SIG}" == "${NEW_SIG}" ]]; then
      echo "[INFO] signature unchanged; no build needed"
      exit 0
    fi

    # Acquire lock with TTL
    if kubectl -n "$NAMESPACE" get configmap "$LOCK_CONFIGMAP_NAME" >/dev/null 2>&1; then
      LOCK_TS="$(kubectl -n "$NAMESPACE" get configmap "$LOCK_CONFIGMAP_NAME" -o jsonpath='{.data.ts}' 2>/dev/null || true)"
      NOW="$(date +%s)"; LOCK_EPOCH="${NOW}"
      if [[ -n "${LOCK_TS}" ]]; then LOCK_EPOCH="$(date -d "${LOCK_TS}" +%s 2>/dev/null || echo "${NOW}")"; fi
      AGE=$((NOW - LOCK_EPOCH))
      if (( AGE > LOCK_TTL_SECONDS )); then
        echo "[WARN] stale lock (age=${AGE}s > ${LOCK_TTL_SECONDS}s), deleting"
        kubectl -n "$NAMESPACE" delete configmap "$LOCK_CONFIGMAP_NAME" || true
      else
        echo "[INFO] lock present and fresh (age=${AGE}s); exiting"
        exit 0
      fi
    fi
    kubectl -n "$NAMESPACE" create configmap "$LOCK_CONFIGMAP_NAME" \
      --from-literal=holder="$(hostname)" \
      --from-literal=ts="$(date -Is)" >/dev/null

    STAMP="$(date +%Y%m%d%H%M%S)"
    JOB_NAME="${JOB_NAME_PREFIX}-${STAMP}"

    cat > /tmp/builder-job.yaml <<'JOBYAML'
    apiVersion: batch/v1
    kind: Job
    metadata:
      name: __JOB_NAME__
      labels:
        app: builder
    spec:
      ttlSecondsAfterFinished: 600
      template:
        metadata:
          labels:
            app: builder
        spec:
          serviceAccountName: webpack-build-sa
          restartPolicy: Never
          containers:
          - name: builder
            image: __BUILDER_IMAGE__
            imagePullPolicy: IfNotPresent
            env:
            - name: HOSTNAME
              value: revproxy-service
            - name: NPM_CONFIG_UPDATE_NOTIFIER
              value: "false"
            - name: APP
              valueFrom:
                configMapKeyRef:
                  key: portal_app
                  name: manifest-global
            - name: GEN3_BUNDLE
              valueFrom:
                configMapKeyRef:
                  key: GEN3_BUNDLE
                  name: manifest-portal
                  optional: true
            - name: LOGOUT_INACTIVE_USERS
              valueFrom:
                configMapKeyRef:
                  key: logout_inactive_users
                  name: manifest-global
                  optional: true
            - name: WORKSPACE_TIMEOUT_IN_MINUTES
              valueFrom:
                configMapKeyRef:
                  key: workspace_timeout_in_minutes
                  name: manifest-global
                  optional: true
            - name: TIER_ACCESS_LEVEL
              valueFrom:
                configMapKeyRef:
                  key: tier_access_level
                  name: manifest-global
                  optional: true
            - name: TIER_ACCESS_LIMIT
              valueFrom:
                configMapKeyRef:
                  key: tier_access_limit
                  name: manifest-global
                  optional: true
            - name: FENCE_URL
              valueFrom:
                configMapKeyRef:
                  key: fence_url
                  name: manifest-global
                  optional: true
            - name: INDEXD_URL
              valueFrom:
                configMapKeyRef:
                  key: indexd_url
                  name: manifest-global
                  optional: true
            - name: WORKSPACE_URL
              valueFrom:
                configMapKeyRef:
                  key: workspace_url
                  name: manifest-global
                  optional: true
            - name: MANIFEST_SERVICE_URL
              valueFrom:
                configMapKeyRef:
                  key: manifest_service_url
                  name: manifest-global
                  optional: true
            - name: WTS_URL
              valueFrom:
                configMapKeyRef:
                  key: wts_url
                  name: manifest-global
                  optional: true
            - name: PRIVACY_POLICY_URL
              valueFrom:
                configMapKeyRef:
                  key: privacy_policy_url
                  name: manifest-global
                  optional: true
            - name: MAPBOX_API_TOKEN
              valueFrom:
                configMapKeyRef:
                  key: mapbox_token
                  name: global
                  optional: true
            - name: DATADOG_APPLICATION_ID
              valueFrom:
                secretKeyRef:
                  key: datadog_application_id
                  name: portal-datadog-config
                  optional: true
            - name: DATADOG_CLIENT_TOKEN
              valueFrom:
                secretKeyRef:
                  key: datadog_client_token
                  name: portal-datadog-config
                  optional: true
            - name: DATA_UPLOAD_BUCKET
              value: "null"

            # Build-specific env
            - name: NODE_ENV
              value: "production"
            - name: NEW_SIG
              value: "__NEW_SIG__"
            - name: WEBPACK_OUTDIR
              value: "/work/out"
            - name: WEBPACK_CACHE_DIR
              value: "/work/cache"

            resources:
              requests:
                memory: "4Gi"

            volumeMounts:
            - name: work
              mountPath: /work
            - name: build-out
              mountPath: /artifacts
            # config/overrides required by builder
            - name: config-volume
              mountPath: /data-portal/data/config/gitops.json
              subPath: gitops.json
              readOnly: true
            - name: sponsor-img-volume
              mountPath: /data-portal/custom/sponsors/gitops-sponsors
              readOnly: true
            - name: privacy-policy
              mountPath: /data-portal/custom/privacy_policy.md
              subPath: privacy_policy.md
              readOnly: true
            - name: portal-overrides
              mountPath: /data-portal/webpack.config.js
              subPath: webpack.config.js
              readOnly: true
            - name: portal-overrides
              mountPath: /data-portal/runWebpack.sh
              subPath: runWebpack.sh
              readOnly: true

            command: ["/bin/bash","-lc"]
            args:
            - |
              set -euo pipefail
              cd /data-portal

              mkdir -p "${WEBPACK_OUTDIR}" "${WEBPACK_CACHE_DIR}"
              export NODE_OPTIONS='--max-old-space-size=3584'
              export NODE_ENV="production"
              echo "[INFO] Starting webpack build to ${WEBPACK_OUTDIR}"

              # Debug info
              echo "[DEBUG] APP=${APP:-unknown}"
              ls -l /data-portal/data/config || true
              if [ -f "/data-portal/data/config/${APP}.json" ]; then
                echo "[DEBUG] Showing first 20 lines of /data-portal/data/config/${APP}.json:"
                sed -n '1,20p' "/data-portal/data/config/${APP}.json" || true
              fi

              # Run the webpack build
              bash runWebpack.sh

              # Stage assets that nginx will serve directly
              echo "[INFO] Staging extra assets into ${WEBPACK_OUTDIR}"
              mkdir -p "${WEBPACK_OUTDIR}/src"
              if [ -d "src/css" ]; then
                echo "[INFO] Copying src/css"
                cp -r src/css "${WEBPACK_OUTDIR}/src/" 2>/dev/null || true
              fi
              if [ -d "src/img" ]; then
                echo "[INFO] Copying src/img"
                cp -r src/img "${WEBPACK_OUTDIR}/src/" 2>/dev/null || true
              fi
              if [ -d "node_modules/@gen3/ui-component/dist/css" ]; then
                echo "[INFO] Copying ui-component css"
                mkdir -p "${WEBPACK_OUTDIR}/node_modules/@gen3/ui-component/dist"
                cp -r node_modules/@gen3/ui-component/dist/css "${WEBPACK_OUTDIR}/node_modules/@gen3/ui-component/dist/" 2>/dev/null || true
              fi

              # Prepare a staging directory for tar
              tmp_dir="/work/${NEW_SIG}"
              mkdir -p "${tmp_dir}"

              # Copy the built output
              cp -a "${WEBPACK_OUTDIR}/." "${tmp_dir}/"

              # Include data directory if present
              if [ -d "data" ]; then
                echo "[INFO] Including data directory"
                mkdir -p "${tmp_dir}/data"
                cp -a data/* "${tmp_dir}/data/" 2>/dev/null || true
              fi

              # Include src directory if present (for completeness)
              if [ -d "src" ]; then
                echo "[INFO] Including src directory"
                mkdir -p "${tmp_dir}/src"
                cp -a src/* "${tmp_dir}/src/" 2>/dev/null || true
              fi

              # Pack everything into a tarball
              echo "[INFO] Creating tarball for ${NEW_SIG}"
              tar -C "/work" -czf "/work/${NEW_SIG}.tar.gz" "${NEW_SIG}"

              # Copy tarball to artifacts (S3 PVC is likely read-only, so sig+sha stay local)
              cp "/work/${NEW_SIG}.tar.gz" "/artifacts/${NEW_SIG}.tar.gz" || true
              echo "${NEW_SIG}" > "/work/${NEW_SIG}.sig"
              sha256sum "/work/${NEW_SIG}.tar.gz" > "/work/${NEW_SIG}.sha256" 2>/dev/null || true

              echo "[INFO] Tarball complete at /artifacts/${NEW_SIG}.tar.gz"
          volumes:
          - name: work
            emptyDir: {}
          - name: build-out
            persistentVolumeClaim:
              claimName: __PVC_NAME__
          - name: config-volume
            secret:
              secretName: portal-config
              defaultMode: 0420
          - name: sponsor-img-volume
            secret:
              secretName: portal-sponsor-config
              defaultMode: 0420
          - name: privacy-policy
            configMap:
              name: privacy-policy
              defaultMode: 0420
          - name: portal-overrides
            secret:
              secretName: portal-overrides
              defaultMode: 0755
    JOBYAML

    # substitute tokens
    sed -i "s#__JOB_NAME__#${JOB_NAME}#g" /tmp/builder-job.yaml
    sed -i "s#__NEW_SIG__#${NEW_SIG}#g" /tmp/builder-job.yaml
    sed -i "s#__BUILDER_IMAGE__#${BUILDER_IMAGE}#g" /tmp/builder-job.yaml
    sed -i "s#__PVC_NAME__#${PVC_NAME}#g" /tmp/builder-job.yaml

    echo "[INFO] applying Job manifest"
    kubectl -n "$NAMESPACE" apply -f /tmp/builder-job.yaml

    # Publish target signature immediately to suppress duplicate jobs
    kubectl -n "$NAMESPACE" create configmap "$SIG_CONFIGMAP_NAME" --from-literal=sig="$NEW_SIG" \
      --dry-run=client -o yaml | kubectl -n "$NAMESPACE" apply -f -

    # Release lock
    kubectl -n "$NAMESPACE" delete configmap "$LOCK_CONFIGMAP_NAME" || true

    echo "[INFO] Builder Job '${JOB_NAME}' created."

# ------------------------------
# Secret: portal overrides (webpack config + run scripts used by builder)
# ------------------------------
---
apiVersion: v1
kind: Secret
metadata:
  name: portal-overrides
type: Opaque
stringData:
  webpack.config.js: |
    /* trimmed for brevity; your previous override kept â€” important bits unchanged */
    const webpack = require('webpack');
    const HtmlWebpackPlugin = require('html-webpack-plugin');
    const path = require('path');
    const fs = require('fs');
    const basename = process.env.BASENAME || '/';
    const basenameWithTrailingSlash = basename.endsWith('/') ? basename : `${basename}/`;
    const pathPrefix = basename.endsWith('/') ? basename.slice(0, basename.length - 1) : basename;
    const app = process.env.APP || 'dev';
    const BUILD_OUTDIR = process.env.WEBPACK_OUTDIR ? path.resolve(process.env.WEBPACK_OUTDIR) : path.resolve(__dirname, 'dist');
    const WEBPACK_CACHE_DIR = process.env.WEBPACK_CACHE_DIR ? path.resolve(process.env.WEBPACK_CACHE_DIR) : path.join(BUILD_OUTDIR, '.webpack-cache');

    const configFileName = (app === 'dev') ? 'default' : app;
    const configFile = require(`./data/config/${configFileName}.json`);
    const DISABLE_CACHE = '1';
    const { DAPTrackingURL, gaTrackingId } = configFile;
    const scriptSrcURLs = []; const connectSrcURLs = []; const imgSrcURLs = [];
    if (DAPTrackingURL) { scriptSrcURLs.push(DAPTrackingURL); connectSrcURLs.push(DAPTrackingURL); }
    if (gaTrackingId?.startsWith('UA-') || gaTrackingId?.startsWith('G-')) {
      scriptSrcURLs.push(...['https://www.google-analytics.com','https://ssl.google-analytics.com','https://www.googletagmanager.com']);
      connectSrcURLs.push(...['https://www.google-analytics.com','https://*.analytics.google.com','https://analytics.google.com','https://*.g.doubleclick.net']);
      imgSrcURLs.push('https://www.google-analytics.com','https://*.g.doubleclick.net','https://*.google.com');
    } else { console.log('Unknown GA tag, skipping GA setup...'); }
    if (process.env.DATA_UPLOAD_BUCKET) { connectSrcURLs.push(`https://${process.env.DATA_UPLOAD_BUCKET}.s3.amazonaws.com`); }
    if (configFile.connectSrcCSPWhitelist && configFile.connectSrcCSPWhitelist.length > 0) { connectSrcURLs.push(...configFile.connectSrcCSPWhitelist); }
    if (configFile.featureFlags?.discoveryUseAggMDS) { connectSrcURLs.push('https://dataguids.org'); }
    if (configFile.featureFlags?.studyRegistration) { connectSrcURLs.push('https://clinicaltrials.gov'); }
    if (process.env.DATADOG_APPLICATION_ID && process.env.DATADOG_CLIENT_TOKEN) {
      connectSrcURLs.push('https://*.logs.datadoghq.com','https://*.browser-intake-ddog-gov.com');
    }
    if (configFile.grafanaFaroConfig?.grafanaFaroEnable) {
      if (configFile.grafanaFaroConfig?.grafanaFaroUrl) connectSrcURLs.push(configFile.grafanaFaroConfig.grafanaFaroUrl);
      else connectSrcURLs.push('https://faro.planx-pla.net');
    }
    if (process.env.MAPBOX_API_TOKEN) {
      connectSrcURLs.push('https://*.tiles.mapbox.com','https://api.mapbox.com','https://events.mapbox.com');
    }
    const iFrameApplicationURLs = [];
    if (configFile?.analysisTools) { configFile.analysisTools.forEach((e)=>{ if (e.applicationUrl) iFrameApplicationURLs.push(e.applicationUrl); }); }
    function getCSSVersion() {
      const overridesCss = './src/css/themeoverrides.css';
      if (!fs.existsSync(overridesCss)) { console.warn(`${overridesCss} does not exist`); return (''); }
      const stats = fs.statSync(overridesCss); return (stats.mtime.getTime());
    }
    const plugins = [
      new webpack.EnvironmentPlugin(['NODE_ENV']),
      new webpack.EnvironmentPlugin({ MOCK_STORE: null }),
      new webpack.EnvironmentPlugin(['APP']),
      new webpack.EnvironmentPlugin({ BASENAME: '/' }),
      new webpack.EnvironmentPlugin(['LOGOUT_INACTIVE_USERS']),
      new webpack.EnvironmentPlugin(['WORKSPACE_TIMEOUT_IN_MINUTES']),
      new webpack.EnvironmentPlugin(['REACT_APP_PROJECT_ID']),
      new webpack.EnvironmentPlugin(['REACT_APP_DISABLE_SOCKET']),
      new webpack.EnvironmentPlugin(['TIER_ACCESS_LEVEL']),
      new webpack.EnvironmentPlugin(['TIER_ACCESS_LIMIT']),
      new webpack.EnvironmentPlugin(['FENCE_URL']),
      new webpack.EnvironmentPlugin(['INDEXD_URL']),
      new webpack.EnvironmentPlugin(['USE_INDEXD_AUTHZ']),
      new webpack.EnvironmentPlugin(['WORKSPACE_URL']),
      new webpack.EnvironmentPlugin(['WTS_URL']),
      new webpack.EnvironmentPlugin(['MANIFEST_SERVICE_URL']),
      new webpack.EnvironmentPlugin(['MAPBOX_API_TOKEN']),
      new webpack.EnvironmentPlugin(['DATADOG_APPLICATION_ID']),
      new webpack.EnvironmentPlugin(['DATADOG_CLIENT_TOKEN']),
      new webpack.EnvironmentPlugin(['DATA_UPLOAD_BUCKET']),
      new webpack.EnvironmentPlugin(['GEN3_BUNDLE']),
      new HtmlWebpackPlugin({
        title: configFile.components.appName || 'Generic Data Commons',
        metaDescription: configFile.components.metaDescription || '',
        basename: pathPrefix,
        cssVersion: getCSSVersion(),
        template: 'src/index.ejs',
        filename: 'index.html',
        connectSrc: ((() => {
          const rv = {};
          const push = u => { try { rv[(new URL(u)).origin] = true; } catch(e){} };
          ['FENCE_URL','INDEXD_URL','WORKSPACE_URL','WTS_URL','MANIFEST_SERVICE_URL']
            .forEach(k => { if (process.env[k]) push(process.env[k]); });
          iFrameApplicationURLs.forEach(u => push(u));
          connectSrcURLs.forEach(u => push(u));
          return Object.keys(rv).join(' ');
        })()),
        scriptSrc: ((() => {
          const rv = {}; const push = u => { try { rv[(new URL(u)).origin] = true; } catch(e){} };
          scriptSrcURLs.forEach(u => push(u));
          return Object.keys(rv).join(' ');
        })()),
        imgSrc: ((() => {
          const rv = {}; const push = u => { try { rv[(new URL(u)).origin] = true; } catch(e){} };
          imgSrcURLs.forEach(u => push(u));
          return Object.keys(rv).join(' ');
        })()),
        dapURL: DAPTrackingURL,
        hash: true,
        chunks: ['vendors~bundle','bundle'],
      }),
      new webpack.optimize.AggressiveMergingPlugin(),
    ];
    const allowedHosts = process.env.HOSTNAME ? [process.env.HOSTNAME] : 'auto';
    let optimization = {}; let devtool = false;
    if (process.env.NODE_ENV !== 'dev' && process.env.NODE_ENV !== 'auto') { optimization = { splitChunks: { chunks: 'all' } }; }
    else { devtool = 'eval-source-map'; }
    const entry = {
      bundle: './src/index.jsx',
      workspaceBundle: './src/workspaceIndex.jsx',
      covid19Bundle: './src/covid19Index.jsx',
      nctBundle: './src/nctIndex.jsx',
      ecosystemBundle: './src/ecosystemIndex.jsx',
    };
    if (process.env.GEN3_BUNDLE) {
      switch (process.env.GEN3_BUNDLE) {
        case 'workspace': entry.bundle = entry.workspaceBundle; delete entry.workspaceBundle; delete entry.covid19Bundle; delete entry.nctBundle; delete entry.ecosystemBundle; break;
        case 'covid19':   entry.bundle = entry.covid19Bundle;   delete entry.workspaceBundle; delete entry.covid19Bundle; delete entry.nctBundle; delete entry.ecosystemBundle; break;
        case 'nct':       entry.bundle = entry.nctBundle;       delete entry.workspaceBundle; delete entry.covid19Bundle; delete entry.nctBundle; delete entry.ecosystemBundle; break;
        case 'heal':
        case 'ecosystem': entry.bundle = entry.ecosystemBundle; delete entry.workspaceBundle; delete entry.covid19Bundle; delete entry.nctBundle; delete entry.ecosystemBundle; break;
        default:          delete entry.workspaceBundle; delete entry.covid19Bundle; delete entry.nctBundle; delete entry.ecosystemBundle;
      }
    }
    module.exports = {
      entry,
      target: 'web',
      externals: [{ xmlhttprequest: '{XMLHttpRequest:XMLHttpRequest}' }],
      mode: process.env.NODE_ENV !== 'dev' && process.env.NODE_ENV !== 'auto' ? 'production' : 'development',
      output: { path: BUILD_OUTDIR, filename: '[name].js', publicPath: basenameWithTrailingSlash },
      cache: false,
      optimization, devtool,
      module: {
        rules: [
          { test: /\.jsx?$|\.tsx?$/, exclude: /node_modules\/(?!(graphiql|graphql-language-service-parser)\/).*/,
            use: { loader: 'babel-loader', options: { presets: ['@babel/preset-env','@babel/react'], plugins: ['@babel/plugin-proposal-class-properties'], cacheDirectory: path.join(WEBPACK_CACHE_DIR,'babel'), cacheCompression: false } } },
          { test: /\.less$/, loaders: ['style-loader','css-loader','less-loader'] },
          { test: /\.css$/,  loader: 'style-loader!css-loader' },
          { test: /\.svg$/,  loader: 'svg-react-loader' },
          { test: /\.(png|jpg|gif|woff|ttf|eot)$/, loaders: 'url-loader', query: { limit: 8192 } },
          { test: /\.flow$/, loader: 'ignore-loader' },
        ],
      },
      resolve: {
        alias: {
          graphql: path.resolve('./node_modules/graphql'),
          react: path.resolve('./node_modules/react'),
          graphiql: path.resolve('./node_modules/graphiql'),
          'graphql-language-service-parser': path.resolve('./node_modules/graphql-language-service-parser'),
        },
        extensions: ['.mjs','.js','.jsx','.ts','.tsx','.json'],
      },
      plugins,
    };
  runWebpack.sh: |
    #!/usr/bin/env bash
    set -euo pipefail
    export APP="${APP:-dev}"
    export NODE_ENV="${NODE_ENV:-dev}"
    export HOSTNAME="${HOSTNAME:-revproxy-service}"
    export BASENAME="${BASENAME:-}"
    export GEN3_BUNDLE="${GEN3_BUNDLE:-commons}"
    export TIER_ACCESS_LEVEL="${TIER_ACCESS_LEVEL:-private}"
    export TIER_ACCESS_LIMIT="${TIER_ACCESS_LIMIT:-1000}"
    export USE_INDEXD_AUTHZ="${USE_INDEXD_AUTHZ:-false}"
    export LOGOUT_INACTIVE_USERS="${LOGOUT_INACTIVE_USERS:-true}"
    export WORKSPACE_TIMEOUT_IN_MINUTES="${WORKSPACE_TIMEOUT_IN_MINUTES:-480}"
    export WEBPACK_OUTDIR="${WEBPACK_OUTDIR:-$(pwd)/dist}"
    export WEBPACK_CACHE_DIR="${WEBPACK_CACHE_DIR:-${WEBPACK_OUTDIR}/.webpack-cache}"
    mkdir -p "${WEBPACK_OUTDIR}" "${WEBPACK_CACHE_DIR}"
    # minimal (your earlier customize.sh invocation)
    bash custom/customize.sh || true
    if [[ "$GEN3_BUNDLE" != "workspace" ]]; then
      npm run schema
      npm run relay
    fi
    echo "INFO: Generating parameters.json"
    npm run params || true
    if [[ "$GEN3_BUNDLE" != "workspace" ]]; then
      npm run sanity-check || true
    fi
    echo "INFO: Building to ${WEBPACK_OUTDIR}"
    export NODE_OPTIONS='--max-old-space-size=3584'
    export NODE_ENV="production"
    npx webpack build --mode production

# ------------------------------
# NGINX config (close to your template)
# ------------------------------
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: portal-nginx-conf
  namespace: default
data:
  default.conf: |
    log_format json '{"gen3log": "nginx", '
        '"date_access": "$time_iso8601", '
        '"user_id": "$http_x_userid", '
        '"request_id": "$http_x_reqid", '
        '"session_id": "$http_x_sessionid", '
        '"visitor_id": "$http_x_visitorid", '
        '"network_client_ip": "$http_x_forwarded_for", '
        '"network_bytes_write": $body_bytes_sent, '
        '"http_response_time": "$request_time", '
        '"http_status_code": $status, '
        '"http_request": "$request_uri", '
        '"http_verb": "$request_method", '
        '"http_referer": "$http_referer", '
        '"http_useragent": "$http_user_agent", '
        '"message": "$request"}';

    access_log /dev/stdout json;

    server {
      listen 80 default_server;

      root /usr/share/nginx/html/;
      index index.html index.htm;

      # dev.html route
      rewrite ^(\/\w+)?\/dev.html.+$ $1/dev.html;

      # block dotfiles
      location ~ /\. {
        deny all;
      }

      # block package/config
      location ^~ /package.json        { deny all; }
      location ^~ /package-lock.json   { deny all; }
      location ^~ /npm-debug.log       { deny all; }
      location ^~ /tsconfig.json       { deny all; }
      location ^~ /webpack.config.js   { deny all; }
      location ^~ /yarn.lock           { deny all; }
      location ^~ /nginx.conf          { deny all; }

      location ~* \.(?:manifest|appcache|html?|xml|json)$ {
        expires -1;
      }

      location ~* \.(?:css|less|js|)$ {
        try_files $uri =404;
        expires 1y;
        access_log off;
        add_header Cache-Control "public";
      }

      # Any route with an extension
      location ~ ^.+\.[^/]+$ {
        try_files $uri =404;
      }

      # SPA: otherwise serve index.html
      location / {
        try_files $uri /index.html;
      }
    }
{{- end -}}