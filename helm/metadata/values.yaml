# Default values for metadata.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# -- (map) Global configuration options.
global:
  # -- (map) AWS configuration
  aws:
    # -- (bool) Set to true if deploying to AWS. Controls ingress annotations.
    enabled: false
    # -- (string) Credentials for AWS stuff.
    awsAccessKeyId:
    # -- (string) Credentials for AWS stuff.
    awsSecretAccessKey:
  # -- (bool) Whether the deployment is for development purposes.
  dev: true
  # -- (map) Postgres database configuration.
  postgres:
    # -- (bool) Whether the database should be created.
    dbCreate: true
    # -- (map) Master credentials to postgres. This is going to be the default postgres server being used for each service, unless each service specifies their own postgres
    master:
      # -- (string) hostname of postgres server
      host:
      # -- (string) username of superuser in postgres. This is used to create or restore databases
      username: postgres
      # -- (string) password for superuser in postgres. This is used to create or restore databases
      password:
      # -- (string) Port for Postgres.
      port: "5432"
  # -- (string) Environment name. This should be the same as vpcname if you're doing an AWS deployment. Currently this is being used to share ALB's if you have multiple namespaces. Might be used other places too.
  environment: default
  # -- (string) Hostname for the deployment.
  hostname: localhost
  # -- (string) ARN of the reverse proxy certificate.
  revproxyArn: arn:aws:acm:us-east-1:123456:certificate
  # -- (string) URL of the data dictionary.
  dictionaryUrl: https://s3.amazonaws.com/dictionary-artifacts/datadictionary/develop/schema.json
  # -- (string) Portal application name.
  portalApp: gitops
  # -- (string) S3 bucket name for Kubernetes manifest files.
  kubeBucket: kube-gen3
  # -- (string) S3 bucket name for log files.
  logsBucket: logs-gen3
  # -- (bool) Whether to sync data from dbGaP.
  syncFromDbgap: false
  # -- (string) Path to the user.yaml file in S3.
  userYamlS3Path: s3://cdis-gen3-users/test/user.yaml
  # -- (bool) Whether public datasets are enabled.
  publicDataSets: true
  # -- (string) Access level for tiers.
  tierAccessLevel: libre
  # -- (bool) Whether network policies are enabled.
  netPolicy: true
  # -- (int) Number of dispatcher jobs.
  dispatcherJobNum: 10
  # -- (bool) Whether Datadog is enabled.
  ddEnabled: false

# -- (map) Postgres database configuration. If db does not exist in postgres cluster and dbCreate is set ot true then these databases will be created for you
postgres:
  # (bool) Whether the database should be restored from s3. Default to global.postgres.dbRestore
  dbRestore: false
  # -- (bool) Whether the database should be created. Default to global.postgres.dbCreate
  dbCreate:
  # -- (string) Hostname for postgres server. This is a service override, defaults to global.postgres.host
  host:
  # -- (string) Database name for postgres. This is a service override, defaults to <serviceName>-<releaseName>
  database:
  # -- (string) Username for postgres. This is a service override, defaults to <serviceName>-<releaseName>
  username:
  # -- (string) Port for Postgres.
  port: "5432"
  # -- (string) Password for Postgres. Will be autogenerated if left empty.
  password:

# Deployment
releaseLabel: "production"

autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 100
  targetCPUUtilizationPercentage: 80

replicaCount: 1

revisionHistoryLimit: 2

strategy:
  type: RollingUpdate
  rollingUpdate:
    maxSurge: 1
    maxUnavailable: 0

dataDog:
  enabled: false
  env: dev

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
    - weight: 100
      podAffinityTerm:
        labelSelector:
          matchExpressions:
          - key: app
            operator: In
            values:
            - metadata
        topologyKey: "kubernetes.io/hostname"

automountServiceAccountToken: false

image:
  repository: quay.io/cdis/metadata-service
  pullPolicy: Always
  # Overrides the image tag whose default is the chart appVersion.
  tag: "master"

debug: false

# Environment Variables
esEndpoint: elasticsearch:9200
useAggMds:
aggMdsNamespace:

livenessProbe:
  httpGet:
    path: /_status
    port: 80
  initialDelaySeconds: 30
  periodSeconds: 60
  timeoutSeconds: 30
readinessProbe:
  httpGet:
    path: /_status
    port: 80

containerPort:
  - containerPort: 80

volumeMounts:
  - name: config-volume-g3auto
    readOnly: true
    mountPath: /src/.env
    subPath: metadata.env
  - name: config-volume
    readOnly: true
    mountPath: /aggregate_config.json
    subPath: aggregate_config.json
  - name: config-manifest
    readOnly: true
    mountPath: /metadata.json
    subPath: json

resources:
  requests:
    cpu: 0.1
    memory: 12Mi
  limits:
    cpu: 1.0
    memory: 512Mi

# Init Container
initContainerName: metadata-db-migrate

initVolumeMounts:
  - name: config-volume-g3auto
    readOnly: true
    mountPath: /src/.env
    subPath: metadata.env

initResources:
  limits:
    cpu: 0.8
    memory: 512Mi

command: ["/bin/sh"]

args:
  - "-c"
  - |
    /env/bin/alembic upgrade head

# Service and Pod
serviceAnnotations:
  getambassador.io/config: |
    ---
    apiVersion: ambassador/v1
    ambassador_id: "gen3"
    kind:  Mapping
    name:  metadata_mapping
    prefix: /index/
    service: http://metadata-service:80

service:
  type: ClusterIP
  port:
    - protocol: TCP
      port: 80
      targetPort: 80
      name: http
