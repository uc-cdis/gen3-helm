location /analysis/v0/ {
  if ($csrf_check !~ ^ok-\S.+$) { return 403 "failed csrf check"; }

  set $proxy_service  "gen3-analysis";
  set $upstream http://gen3-analysis-service$des_domain;

  # keep as-is: strip the prefix so upstream is mounted at /
  rewrite ^/analysis/v0/?(.*)$ /$1 break;

  proxy_pass $upstream;

  # Re-prefix upstream redirects like "Location: /docs" -> "/analysis/v0/docs"
  proxy_redirect ~^(/docs(?:/.*)?)$ /analysis/v0$1;

  # (Optional) if upstream ever returns absolute URLs, catch those too:
  proxy_redirect ~^https?://[^/]+(/docs(?:/.*)?)$ https://$host/analysis/v0$1;

  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Proto $scheme;

  # Helpful if the app/Swagger respects it:
  proxy_set_header X-Forwarded-Prefix /analysis/v0;
}