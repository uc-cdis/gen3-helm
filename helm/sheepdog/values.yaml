# Default values for sheepdog.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# -- (map) Global configuration options.
global:
  # -- (map) AWS configuration
  aws:
    # -- (bool) Set to true if deploying to AWS. Controls ingress annotations.
    enabled: false
    # -- (string) Credentials for AWS stuff.
    awsAccessKeyId:
    # -- (string) Credentials for AWS stuff.
    awsSecretAccessKey:
  # -- (bool) Whether the deployment is for development purposes.
  dev: true
  # -- (map) Postgres database configuration.
  postgres:
    # -- (bool) Whether the database should be created.
    dbCreate: true
    # -- (map) Master credentials to postgres. This is going to be the default postgres server being used for each service, unless each service specifies their own postgres
    master:
      # -- (string) hostname of postgres server
      host:
      # -- (string) username of superuser in postgres. This is used to create or restore databases
      username: postgres
      # -- (string) password for superuser in postgres. This is used to create or restore databases
      password:
      # -- (string) Port for Postgres.
      port: "5432"
  # -- (string) Environment name. This should be the same as vpcname if you're doing an AWS deployment. Currently this is being used to share ALB's if you have multiple namespaces. Might be used other places too.
  environment: default
  # -- (string) Hostname for the deployment.
  hostname: localhost
  # -- (string) ARN of the reverse proxy certificate.
  revproxyArn: arn:aws:acm:us-east-1:123456:certificate
  # -- (string) URL of the data dictionary.
  dictionaryUrl: https://s3.amazonaws.com/dictionary-artifacts/datadictionary/develop/schema.json
  # -- (string) Portal application name.
  portalApp: gitops
  # -- (string) S3 bucket name for Kubernetes manifest files.
  kubeBucket: kube-gen3
  # -- (string) S3 bucket name for log files.
  logsBucket: logs-gen3
  # -- (bool) Whether to sync data from dbGaP.
  syncFromDbgap: false
  # -- (string) Path to the user.yaml file in S3.
  userYamlS3Path: s3://cdis-gen3-users/test/user.yaml
  # -- (bool) Whether public datasets are enabled.
  publicDataSets: true
  # -- (string) Access level for tiers.
  tierAccessLevel: libre
  # -- (bool) Whether network policies are enabled.
  netPolicy: true
  # -- (int) Number of dispatcher jobs.
  dispatcherJobNum: 10
  # -- (bool) Whether Datadog is enabled.
  ddEnabled: false

# -- (map) Postgres database configuration. If db does not exist in postgres cluster and dbCreate is set ot true then these databases will be created for you
postgres:
  # (bool) Whether the database should be restored from s3. Default to global.postgres.dbRestore
  dbRestore: false
  # -- (bool) Whether the database should be created. Default to global.postgres.dbCreate
  dbCreate:
  # -- (string) Hostname for postgres server. This is a service override, defaults to global.postgres.host
  host:
  # -- (string) Database name for postgres. This is a service override, defaults to <serviceName>-<releaseName>
  database:
  # -- (string) Username for postgres. This is a service override, defaults to <serviceName>-<releaseName>
  username:
  # -- (string) Port for Postgres.
  port: "5432"
  # -- (string) Password for Postgres. Will be autogenerated if left empty.
  password:
  # -- (string) Will create a Database for the individual service to help with developing it.
  separate: false

# This is to configure postgresql subchart
# Disable persistence by default so we can spin up and down ephemeral environments
postgresql:
  primary:
    persistence:
      enabled: false

# Deployment
releaseLabel: production

podAnnotations: {"gen3.io/network-ingress": "sheepdog"}

autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 100
  targetCPUUtilizationPercentage: 80

replicaCount: 1

revisionHistoryLimit: 2

strategy:
  type: RollingUpdate
  rollingUpdate:
    maxSurge: 1
    maxUnavailable: 0

dataDog:
  enabled: false
  env: dev

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
    - weight: 100
      podAffinityTerm:
        labelSelector:
          matchExpressions:
          - key: app
            operator: In
            values:
            - sheepdog
        topologyKey: "kubernetes.io/hostname"

automountServiceAccountToken: false


# sheepdog transactions take forever - try to let the complete before termination
terminationGracePeriodSeconds: 50

image:
  repository: quay.io/cdis/sheepdog
  pullPolicy: Always
  # Overrides the image tag whose default is the chart appVersion.
  tag: "helm-test"

# Environment Variables
dictionaryUrl: https://s3.amazonaws.com/dictionary-artifacts/datadictionary/develop/schema.json
indexdUrl: http://indexd-service
fenceUrl: http://fence-service
arboristUrl: http://arborist-service
authNamespace: default

# Placeholders for datadog
ddTraceEnabled:
ddEnv:
ddService:
ddVersion:
ddLogsInjection:
ddProfilingEnabled:
ddTraceSampleRate:
ddTraceAgentHostname:


livenessProbe:
  httpGet:
    path: /_status?timeout=20
    port: 80
  initialDelaySeconds: 30
  periodSeconds: 60
  timeoutSeconds: 30

readinessProbe:
  initialDelaySeconds: 30
  httpGet:
    path: /_status?timeout=2
    port: 80

ports:
- containerPort: 80
- containerPort: 443

volumeMounts:
  - name: "config-volume"
    readOnly: true
    mountPath: "/var/www/sheepdog/wsgi.py"
    subPath: "wsgi.py"

resources:
  requests:
    cpu: 0.3
    memory: 12Mi
  limits:
    cpu: 1.0
    memory: 512Mi

# Service and Pod
service:
  type: ClusterIP
  port: 80

# Secrets
secrets:
  fence:
    host: postgres-postgresql.postgres.svc.cluster.local
    user: postgres
    password: postgres
    database: fence
  sheepdog:
    host: postgres-postgresql.postgres.svc.cluster.local
    password: postgres
    user: postgres
    database: sheepdog
  gdcapi:
    secretKey:
  indexd:
    password: postgres
